<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<link rel="stylesheet" href="css/electricroommonitoring.css"/>
	<title>实时数据</title>
	<script  type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script  type="text/javascript" src="js/config.js"></script>
	<script  type="text/javascript" src="js/jquery.tablesort.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.js" ></script>
	<script type="text/javascript" src="js/bootstrap-treeview.min.js" ></script>
	<script  type="text/javascript" src="js/function.js"></script>
	<script  type="text/javascript" src="js/layer/layer.js"></script>
	
	<style type="text/css">
    *{
       margin:0px;
       padding:0px;
    }
    /**/
    th,td{
        border:1px solid black;
        text-align:center;
        line-height:center;
        width:200px;
        height:30px;
    }
    td{
        border:1px solid black;
        text-align:center;
        line-height:center;
    }
	* {
		margin: 0;
		padding: 0;
	}
	table {
		/*设置相邻单元格的边框间的距离*/
		border-spacing: 0;
		/*表格设置合并边框模型*/
		border-collapse: collapse;
		text-align: center;
	}
	/*关键设置 tbody出现滚动条 height: 500px;overflow-y: scroll;*/
	table tbody {
		display: block;
	}
	table thead,
	tbody tr {
		display: table;
		table-layout: fixed;
	}
	/*关键设置：滚动条默认宽度是16px 将thead的宽度减16pxwidth: 100%;
	table thead {
		width: calc( tbody.width )
		color:#0000ff;
	}
	table thead th {
		background: #ccc;
	}*/
  </style>
</head>
<body onload="getrealdatabynodeid(-1)" onunload="stopWorker()">
	<div>
		<div class="pagecard" id="pagecard1" style="margin-bottom:10px">
			<h3 id="head_real" align="center" >实时数据</h3>
			<!--ul class="pc-nav" >
				<li ><a href="#" target="iframe_main"><i>数据列表</i></a></li>
				<li ><a href="#" target="iframe_main"><i>变化曲线</i></a></li>
			</ul-->
		</div>
		<div >
		<div  class="row" style="margin-bottom:10px;width=100%;overflow:auto;" align="center">
			<ul class="count_info" align="center" widht="1000px" >
				<li style="width:50px"><b>站名：</b></li>
				<li id="station_name"style="width:50px;margin-right:0px"> </li>
				<li style="width:30px;margin-right:10px"><b>记录：</b></li>
				<li id="count_val"style="width:30px;margin-right:0px"> </li>
				<!-- 
				<li style="width:50px;margin-right:0px"><b>正常数：</b> </li>
				<li id="normal_count"style="width:150px;margin-right:0px"> </li>-->
				<li style="width:30px;margin-right:0px"><b>异常：</b></li>
				<li id="err_count"style="width:30px;margin-right:0px"> </li>
				<li style="width:100px;margin-right:0px"><a href="#" style="align:right;margin-left:20px;" onclick="method5('realtable')">导出Excel</a></li>
			</ul>
		</div>
		</div>
		<div align="center" style="overflow:auto;">
		<table class="tabtop13" id="realtable" width="1200px" >
			<thead>
				<tr >
				<th style="color:#0000ff" onclick="sortt('.sensorname')" ><a href="javascript:">监测点名称<span class="sensorname"></span> </a></th>
				<!--th>数据编号</thonclick="sortt('.tmpvalue')"-->
				<th style="color:#0000ff" onclick="sortt('.time')"><a href="javascript:">测量时间 <span class="time"></span></a></th>
				<th style="color:#0000ff" onclick="sortt('.value1')"><a href="javascript:">峰值<span class="value1"></span></a></th>
				<th style="color:#0000ff" onclick="sortt('.value2')"><a href="javascript:">均值 <span class="value2"></span></a></th>
				<th style="color:#0000ff">查看历史数据</th>
				<th style="color:#0000ff">查看告警信息</th> 
				<!--<th style="width:18px;border:0px solid black;"></th>-->
				</tr>
			</thead>
			<tbody id='realdata-tbody'>
			</tbody>
		</table>
	</div>
	</div>
	<script type="text/javascript">
		//var t1 = window.setInterval("getrealdatabystation(1);",30000);
		/*if(typeof(Worker) !== "undefined") {//只在网络状态下可用，本地磁盘目录下不可用。
        if(typeof(w1) == "undefined") {
            w1 = new Worker("delay_worker.js");
        }
		i=0;
        w1.onmessage = function(event) {
            //document.getElementById("result").innerHTML = event.data;
			i++
			if(i%30==0){
				getrealdatabystation(1);
			}
        };
		} else {
			//document.getElementById("result").innerHTML = "抱歉，你的浏览器不支持 Web Workers...";
			var t1 = window.setInterval("getrealdatabystation(1);",30000);
		}*/
		//表格排序使用插件
		$(function() {
			$('table').tablesort().data('tablesort');
		})
		function stopWorker() 
		{ 
			w1.terminate();
			w1 = undefined;
		}
		
		var obj_realdata=new JSONObject();

	function getrealdatabynodeid(nodeid){
		sessionStorage.pageindex = 2;
		var count = 0,
		err_count = 0;
		if (nodeid!=undefined&&nodeid!==null) {
			var url = jfjk_base_config.baseurl + "GetRealsNew?dataId=" + nodeid;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'GET',
					dataType: 'json',
					timeout: 10000,
					error: function(jqXHR, textStatus, errorThrown) {
						errortime++;
						if (errorThrown == "Unauthorized") {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  未授权或授权已过期； 获取站实时数据操作失败');
						} else {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  ' + jqXHR.responseText + ' 获取站实时数据操作失败');
						}
					},
					success: function(data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						if (status == "success") {
							errortime = 0;
							sessionStorage.islogin = true;
							if (data.Error == null) {
								if (jQuery.isEmptyObject(data.Result.Datas)) {
									if (id == 0) {
										//layer.alert("没有符合条件的记录",2000);
										layer.alert("没有符合条件的记录");
									}
									return;
								}
								//if (data.Result.Datas.length>0) {
									/**/
									obj_realdata=data.Result.Datas;
									decoderealdata();
									/*var tbody = document.getElementById('realdata-tbody');
									var trs = tbody.getElementsByTagName("tr");
									//data.Result.Datas.Tmp.sort(data.Result.Datas.Tmp.SensorId);
									for (var i = 0; i < data.Result.Datas.Tmp.length; i++) {
										//更新原有的列表项的数据内容
										for (var j = 0; j < trs.length; j++) {
											if (trs[j].cells[0].childNodes[0].data == data.Result.Datas.Tmp[i].SensorId) {
												trs[j].cells[2].innerHTML = data.Result.Datas.Tmp[i].Time;
												trs[j].cells[3].innerHTML = data.Result.Datas.Tmp[i].Value;
												break;
											}
										}
										//新增数据列表项
										if (j >= trs.length) {
											var tr = document.createElement('tr');
											var tdid = document.createElement('td');
											var tdename = document.createElement('td');
											//var tdsalary=document.createElement('td');
											var tdage = document.createElement('td');
											var tddiscr = document.createElement('td');
											var tdhistory = document.createElement('td');
											var tdwarnlog = document.createElement('td'); {
												tdid.innerHTML = data.Result.Datas.Tmp[i].SensorId;
											}
											for (j = 0; j < data.Result.Sensors.Sensors.length; j++) {
												if (data.Result.Datas.Tmp[i].SensorId == data.Result.Sensors.Sensors[j].Id) {
													tdename.innerHTML = data.Result.Sensors.Sensors[j].Name;
													break;
												}
											}
											//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
											tdage.innerHTML = data.Result.Datas.Tmp[i].Time; //jsonObject[i].color;
											tddiscr.innerHTML=parseFloat(data.Result.Datas.Tmp[i].Value).toFixed(Number_of_decimal);
											tdhistory.setAttribute('backgroundColor', '#ffffff');
											tdhistory.setAttribute('onclick', 'tohistory(' + tdid.innerHTML + ')');
											tdhistory.innerHTML = "<button href='javascript:void(0)'>>></button>";
											tdwarnlog.setAttribute('onclick', 'towarnlog(' + tdid.innerHTML + ')');
											tdwarnlog.setAttribute('backgroundColor', '#ffffff');
											tdwarnlog.innerHTML = '<button href="javascript:void(0)">>></button>';
											tr.appendChild(tdid);
											tr.appendChild(tdename);
											tr.appendChild(tdage);
											tr.appendChild(tddiscr);
											tr.appendChild(tdhistory);
											tr.appendChild(tdwarnlog);
											//隔行显示不同的延时
											if (i % 2 == 0) {
												tr.cells[0].style.backgroundColor = "#16b9c9";
												tr.cells[1].style.backgroundColor = "#16b9c9";
												tr.cells[2].style.backgroundColor = "#16b9c9";
												tr.cells[3].style.backgroundColor = "#16b9c9";
											} else {
												tr.cells[0].style.backgroundColor = "#FFFFFF";
												tr.cells[1].style.backgroundColor = "#FFFFFF";
												tr.cells[2].style.backgroundColor = "#FFFFFF";
												tr.cells[3].style.backgroundColor = "#FFFFFF";
											}
											//tdage.setAttribute('class','time');
											//tdid.setAttribute('class','sensorid');
											//tddiscr.setAttribute('class','tmpvalue');
											//tdename.setAttribute('class','sensorname');
											var tbody = document.getElementById('realdata-tbody');
											tbody.appendChild(tr);
										}
									}
									count = data.Result.Datas.Tmp.length;*/
									//parent.window.showfudongdiv();
								//}
								if (data.Result.Datas.hasOwnProperty("Err")) {
									for (var i = 0; i < data.Result.Datas.Err.length; i++) {
										if (jQuery.isEmptyObject(data.Result.Datas.Err[i].Value)) {
											for (var j = 0; j < trs.length; j++) {
												if (trs[j].cells[0].childNodes[0].data == data.Result.Datas.Err[i].SensorId) {
													trs[j].cells[3].style.backgroundColor = trs[j].cells[2].style.backgroundColor;
													//err_count++;
													break;
												}
											}
											continue;
										}
										for (var j = 0; j < trs.length; j++) {
											if (trs[j].cells[0].childNodes[0].data == data.Result.Datas.Err[i].SensorId) {
												trs[j].cells[3].style.backgroundColor = "#FFFF00";
												err_count++;
												break;
											}
										}
									}
									//err_count=data.Result.Datas.Err.length;
								}
								document.getElementById('count_val').innerHTML = count + "条";
								//document.getElementById('normal_count').innerHTML=count-err_count+"条";
								document.getElementById('err_count').innerHTML = err_count + "条";
							} else {
								layer.alert(data.Error, 2000);
							}
						}
					}
				});
			} else {
				layer.alert("与服务器连接失败");
				//window.location.href="index.html";
			}
			document.getElementById('station_name').innerHTML = sessionStorage.stationName;
		}
	}
	function decoderealdata(){
		//if(obj_realdata.length>=0){
			var sensors=JSON.parse(localStorage.getItem("sensors"));
			var obj_data=new Object();
			var pt=0;
			for(var i=0;i<sensors.length;i++){
				var sid=sensors[i].id+"";
				if(obj_realdata.hasOwnProperty(sid)){
					var sname=sensors[i].Value.Name;
					var xs=sensors[i].Value.Factor;
					obj_data=(obj_realdata)[sid];////
					//添加数据列表项
					var tbody = document.getElementById('realdata-tbody');
					var tr = document.createElement('tr');
					//
					var tdename = document.createElement('td');
					//var tdsalary=document.createElement('td');
					var tdtime = document.createElement('td');
					var tdvalue = document.createElement('td');
					var tdvalue2 = document.createElement('td');
					var tdhistory = document.createElement('td');
					var tdwarnlog = document.createElement('td');
					tdename.innerHTML = sname;
					tdtime.innerHTML = obj_data[0].Time; //jsonObject[i].color;
					tdvalue.innerHTML=(obj_data[0].Value*xs).toFixed(Number_of_decimal);
					tdvalue2.innerHTML = (obj_data[0].Value*xs).toFixed(Number_of_decimal);
					tdhistory.setAttribute('backgroundColor', '#ffffff');
					tdhistory.setAttribute('onclick', 'tohistory(' + sid + ')');
					tdhistory.innerHTML = "<button href='javascript:void(0)'>>></button>";
					tdwarnlog.setAttribute('onclick', 'towarnlog(' +sid + ')');
					tdwarnlog.setAttribute('backgroundColor', '#ffffff');
					tdwarnlog.innerHTML = '<button href="javascript:void(0)">>></button>';
					tr.appendChild(tdename);
					tr.appendChild(tdtime);
					tr.appendChild(tdvalue);
					tr.appendChild(tdvalue2);
					tr.appendChild(tdhistory);
					tr.appendChild(tdwarnlog);
					//隔行显示不同的延时
					if (pt % 2 == 0) {
						tr.cells[0].style.backgroundColor = "#16b9c9";
						tr.cells[1].style.backgroundColor = "#16b9c9";
						tr.cells[2].style.backgroundColor = "#16b9c9";
						tr.cells[3].style.backgroundColor = "#16b9c9";
					} else {
						tr.cells[0].style.backgroundColor = "#FFFFFF";
						tr.cells[1].style.backgroundColor = "#FFFFFF";
						tr.cells[2].style.backgroundColor = "#FFFFFF";
						tr.cells[3].style.backgroundColor = "#FFFFFF";
					}
					pt++;
					//tdage.setAttribute('class','time');
					//tdid.setAttribute('class','sensorid');
					//tddiscr.setAttribute('class','tmpvalue');
					//tdename.setAttribute('class','sensorname');
					var tbody = document.getElementById('realdata-tbody');
					tbody.appendChild(tr);
				}
			}
		//}
	}

	</script>
</body>
</html>