<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<!--script src="js/zrender.min.js"></script-->
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script type="text/javascript" src="js/echarts.js"></script>
	<script type="text/javascript" src="js/jquery.table2excel.min.js"></script>
	<script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
	<link rel="stylesheet" href="css/electricroommonitoring.css" />
	<script type="text/javascript" src="js/layer/layer.js"></script>
	<title>趋势图</title>
	<script type="text/javascript" src="js/function.js"></script>
	<style>
		html,
		body,
		#main {
			width: 100%;
			height: 100%;
		}
		.title-right {
			width:100px;
		}
		input:checked + span {
			color: #337ab7;
			font-weight: bold;
		}
		*{
			margin:0px;
			padding:0px;
		}
    /**/
		th,td{
			border:1px solid black;
			text-align:center;
			line-height:center;
			width:200px;
			height:30px;
		}
		td{
			border:1px solid black;
			text-align:center;
			line-height:center;
		}
		* {
			margin: 0;
			padding: 0;
		}
		table {
			/*设置相邻单元格的边框间的距离*/
			border-spacing: 0;
			/*表格设置合并边框模型*/
			border-collapse: collapse;
			text-align: center;
		}
		/*关键设置 tbody出现滚动条height: 450px;overflow-y: scroll;*/
		table tbody {
			display: block;
		}
		table thead,
		tbody tr {
			display: table;
			table-layout: fixed;
		}
		/*关键设置：滚动条默认宽度是16px 将thead的宽度减16pxwidth: 100%;
		
		table thead {
			width: calc( tbody.width )
		}
		table thead th {
			background: #ccc;
		}*/
	</style>
</head>
<body>
	<div>
		<div class="pagecard" id="pagecard1">
			<p style="text-align:center;font-size:20px"><b>趋势对比</b></p>
		</div>
		<div class="parent" style="text-align: center;">
			<div class="column" id="main" align="center"
				style="background-color: #dcdcdc; height:600px;width:1000px;MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 20px;flex:2.5;">
			</div>
			<div class="column" id="fine" style="MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 10px;text-align: left;">
				<div sytle="text-align:left;float:left">
				<p><label class="title-right" >时间选择：</label><input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" id="cxsj" 
					style="width:130px;font-size:16px;height: 30px;border-radius: 5px;"></input>
				</p>
				<div style="font-size: 16px;">
					<label class="title-right">显示内容：</label>
					<span class="dropup" style="position: relative;">
					<!--<button class="btn btn-default dropdown-toggle form-control select_multiple" style="width: 90px;margin-left: 0px;" type="button" id="dropdownMenu21" data-toggle="dropdown">
						<span class="select_text" data-is-select="false">Dro pup</span>
						<span class="caret"></span>
					</button>-->
					<label class="dropdown-toggle select_multiple" data-toggle="dropdown">
						<input id="select_text" class="select_text " data-is-select="false" style="line-height: 25px;color:black;border-radius: 5px;"></input>
					</label>
					<ul class="dropdown-menu dropdown_item" style="bottom: auto;" id="display_type">
						<!--<li><label><input type="checkbox" class="check_box" value="aa" /> <span>越上限</span></label></li>
						<li><label><input type="checkbox" class="check_box" value="bb" /> <span>越下限</span></label></li>为了方便演示，type设置text了，实际中可以设置成hidden -->
					</ul> 
					</span>
				</div>
				<p><label class="title-right">计量点名称：</label>
					<a id="refreshlist" class="glyphicon glyphicon-refresh" href="javascript:void(0)" onclick="refreshsensorslist()"></a>
						<!--<select id="jcdd" style="font-size:18px;width:253px;vertical-align:-10%;" onchange="gradeChange()">
					</select>-->
					<input class="button" type="button" id="chaxun" value="对比" onclick="oneChoice()"
						style="font-size:16px;height: 30px;line-height: 30px;"></input>
					<input class="button" type="button" id="allcheck" value="取消选择" onclick="allChoice()"
						style="font-size:16px;width:100px;height: 30px;line-height: 30px;"></input>
						<a href="javascript:void(0)" style="margin-left:20px;" onclick="exporttoexcel('compratetable')">
							<img src="res/gif_export.gif" alt="Big Boat" title="导出到Excel" class="img-thumbnail img-responsive"></a>
				</p>
				<form  id="jcdd" style="background-color: #dcdcdc;height: 550px;overflow: auto;font-size:16px;">
					<p><input type="checkbox" value="0" οnclick="allChoice()" id="allCheck" name="checks"/>全选 </p>
				</form>
				</div>
			</div>
		</div>
		<div align="center" >
			<table id="compratetable" style="display: none;">
				<caption style="text-align: center;font-size:18px;">多点数据比对</caption>
				<tr >
					<th>测量点名称</th>
					<th>测量时间</th>
					<th>数值</th>	
					<th>备注</th>
				</tr>
				<tbody id='comprate-tbody' style="width:1020px;height:600px; overflow:auto;">
				</tbody>
			</table>
		</div>
	</div>
	<script>
		//初始化历史数据图形显示页面（在进入趋势图页面时触发）。人之初性本善性相近习相远
		var check_val = [],check_name=[];
		var kssj,jssj;
		var sensors,configs;
		updatapcnav(7);
		inithistorychart();
		function inithistorychart() {
			//return;
			sessionStorage.pageindex = 4;
			var parentid = -100, parentname = "";
			var maps = [];
			document.getElementById("cxsj").value = (sessionStorage.cxsj).substr(0,11);
			var sel_sensor = document.getElementById("jcdd");
			for (var i = sel_sensor.length-1; i >= 0; i--) {
				sel_sensor.removeChild(sel_sensor.children[i]);
			}
			sensors=JSON.parse(localStorage.getItem("sensors"));
			configs=JSON.parse(localStorage.Configs);
			
			if (sensors != null) {
				for (var i = 0; i < sensors.length; i++) {
					if ((sensors[i].Value.ParentId != "-1") && (sensors[i].Value.ParentId != parentid)) {
						parentid = sensors[i].Value.ParentId;
						for (var j = 0; j < sensors.length; j++) {
							if (sensors[j].id == parentid) {
								parentname = sensors[j].Value.Name + "_";
								break;
							}
						}
					}
					var map = new Object();
					map.value = sensors[i].id;
					map.name = parentname + sensors[i].Value.Name;
					maps.push(map);
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.name;
					var val2 = obj2.name;
					return val1.localeCompare(val2);
					/*if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}*/
				}
				maps.sort(compare);
				for (var k = 0; k < maps.length; k++) {
					var p = document.createElement("p");
					var lab=document.createElement("label");
					var input=document.createElement("input");
					input.setAttribute("type","checkbox");
					input.setAttribute("name","checks");
					input.setAttribute("id",maps[k].name);
					input.setAttribute("value",maps[k].value);
					input.setAttribute('onclick','itemclick(this)');
					var spn=document.createElement("span");
					spn.innerHTML=maps[k].name;
					lab.appendChild(input);
					lab.appendChild(spn);
					p.appendChild(lab);
					sel_sensor.appendChild(p);
				}
			}
			appenddisplaytype();
			//setSelectOption("jcdd", sessionStorage.SensorId);
			//querychartvalue();
		}
		//添加显示控制选项
		function appenddisplaytype(){
			allconfigs=JSON.parse(localStorage.Configs);
    		if(allconfigs){
				for(var ac in allconfigs){//如果有，读取其所有配置项
            		var s_des=allconfigs[ac];//如果有，读取其所有配置项
					for(var p in s_des){
						var li=document.createElement("li");
						var lab=document.createElement("label");
						//lab.setAttribute("style","margin-left:20px")
						var ainput=document.createElement("input");
						ainput.setAttribute("type","checkbox");
						ainput.setAttribute("name","checkbox");
						ainput.setAttribute("value",s_des[p].Name);
						ainput.className="check_box";
						var spn=document.createElement("span");
						spn.innerHTML=s_des[p].Desc;
						lab.appendChild(ainput);
						lab.appendChild(spn);
						//lab.innerHTML='<input class="catalog" type="checkbox" name="options" value="'+s_des[p].Name+'" >'+s_des[p].Desc;
						li.appendChild(lab);
						document.getElementById("display_type").appendChild(li);
					}
				}
			}
		}
		function itemclick(obj){
			var allobj = $('[name="checks"]');
			var c=0;
			for(k in allobj){
				if(allobj[k].checked){
					c++;
				}
			}
			if(c>6){
				obj.checked=false;
				alert("对比测量点不能大于6个!",info_showtime);
			}
		}
		function refreshsensorslist() {
			window.parent.GetSensorsByNode(sessionStorage.nodeId);
		}
		function allChoice(){
			var obj = $('[name="checks"]');
			var btn=document.getElementById("allcheck")
			//if(btn.value=="全选"){
			//	for(var i=0;i<obj.length;i++){
			//		obj[i].checked=true;
			//	}
			//	btn.value="全不选";
			//}else{
				for(var i=0;i<obj.length;i++){
					obj[i].checked=false;
				}
			//	btn.value="全选";
			//}
		}
		//对比按钮
		function oneChoice(){
			kssj=document.getElementById("cxsj").value+" 00:00:00"
			jssj=document.getElementById("cxsj").value+" 23:59:59"
			sessionStorage.cxsj=jssj;
			var obj = $('[name="checks"]');
			check_name=[];check_val=[];
			for(k in obj){
				if(obj[k].checked && obj[k].value != "-1"){
					check_val.push(parseInt(obj[k].value));
					check_name.push(obj[k].id);
				}
			}
			gethistorybysensors(check_val);
		}
		function gethistorybysensors(arr_sensors){
			var url = jfjk_base_config.baseurl + "/GetHistoriesBySensors?from="+kssj+"&to="+jssj;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'POST',
					dataType: 'json',
					contentType: "application/json",
					data:JSON.stringify(arr_sensors),
					timeout: 10000,
					error: function(jqXHR, textStatus, errorThrown) {
						sessionStorage.errortime++;
						ajaxLoadingHidden();
						decodedatas([]);//20200214,传一个空数组
						//myChart.hideLoading();
						if (errorThrown == "Unauthorized") {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  未授权或授权已过期； 获取历史数据操作失败',info_showtime);
						} else {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  ' + jqXHR.responseText + ' 获取历史数据操作失败',info_showtime);
						}
						if(sessionStorage.errortime>3){
							sessionStorage.islogin=false;
							sessionStorage.errortime=0;
						}
					},
					success: function(data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						ajaxLoadingHidden();
						if (status == "success") {
							sessionStorage.errortime = 0;
							sessionStorage.islogin = true;
							if (data.Error == null) {
								if (!jQuery.isEmptyObject(data.Result.Datas)) {
									decodedatas( data.Result.Datas);
								} else {
									layer.alert("没有符合条件的记录",info_showtime);
									decodedatas([]);//20200214,传一个空数组
								}
							} else {
								decodedatas([]);//20200214,传一个空数组
								layer.alert(data.Error,info_showtime);
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", info_showtime);
			}
		}
	
		$(document).on("click",".check_box",function(event){
		event.stopPropagation();//阻止事件冒泡，防止触发li的点击事件
		//勾选的项
		var $selectTextDom=$(this).parent().parent().parent("ul").siblings("label").children(".select_text");
		//勾选项的值
		//var $selectValDom=$(this).parent().parent().parent("ul").siblings(".select_val");
		//是否有选择项了
		var isSelected=$selectTextDom[0].getAttribute("data-is-select");
		var selectText="";//文本值，用于显示
		//var selectVal=$selectValDom.val();//实际值，会提交到后台的
		var selected_text=$(this).siblings("span").text();//当次勾选的文本值
		var selected_val=$(this).val();//当次勾选的实际值
		//判断是否选择过
		if(isSelected=="true"){
			selectText=$selectTextDom.val();
		}
		if(selectText!=""){
			if(selectText.indexOf(selected_text)>=0){//判断是否已经勾选过
				selectText=selectText.replace(selected_text,"").replace(";;",";");//替换掉
				//selectVal=selectVal.replace(selected_val,"").replace(",,",",");//替换掉
				//判断最后一个字符是否是逗号
				if(selectText.charAt(selectText.length - 1)==";"){
					//去除末尾逗号
					selectText=selectText.substring(0,selectText.length - 1);
					//selectVal=selectVal.substring(0,selectVal.length - 1);
				}
				//判断第一个字符是否是逗号，是的话去掉。
				if(selectText.charAt(0)==";"){
					selectText=selectText.substring(1);
				}
			}else{
				selectText+=";"+selected_text;
				//selectVal+=","+selected_val;
			}
		}else{
			selectText=selected_text;
			//selectVal=selected_val;
		}
		$selectTextDom.val(selectText);
		//$selectValDom.val(selectVal);
		if(selectText==""){
			$selectTextDom.text("请选择");
			$selectTextDom[0].setAttribute("data-is-select","false");
		}else{
			$selectTextDom[0].setAttribute("data-is-select","true");
		}
		var i_sel=$('input[name="timeselect"]:checked').val();//20200403添加筛选条件改变后自动刷新列表
		switch(i_sel*1){
			case 0:	case 1:	case 2:	case 3:	case 4:
				gethistorydata(sessionStorage.SensorId,"event","",sessionStorage.kssj,sessionStorage.jssj);
				break;
			case 5:
				showrealworning();
				break;
		}
	})
	</script>
</body>
</html>