<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<!--script src="js/zrender.min.js"></script-->
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script type="text/javascript" src="js/echarts.js"></script>
	<script type="text/javascript" src="js/jquery.table2excel.min.js"></script>
	<script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
	<link rel="stylesheet" href="css/electricroommonitoring.css" />
	<script type="text/javascript" src="js/layer/layer.js"></script>
	<title>趋势图</title>
	<script type="text/javascript" src="js/function.js"></script>
	<style>
		html,body{
			width: 100%;
			height: 100%;
		}
		.title-right {
			width:120px;
		}/**/
		input:checked + span {
			color: #337ab7;
			font-weight: bold;
		}
		th,td{
			border:1px solid black;
			text-align:center;
			/*line-height:center;*/
			width:200px;
			height:30px;
		}
		table {
			/*设置相邻单元格的边框间的距离*/
			border-spacing: 0;
			/*表格设置合并边框模型*/
			border-collapse: collapse;
			text-align: center;
		}
		/*关键设置 tbody出现滚动条height: 450px;overflow-y: scroll;*/
		table tbody {
			display: block;
		}
		table thead,
		tbody tr {
			display: table;
			table-layout: fixed;
		}
		/*关键设置：滚动条默认宽度是16px 将thead的宽度减16pxwidth: 100%;
		table thead {
			width: calc( tbody.width )
		}
		table thead th {
			background: #ccc;
		}*/
	</style>
</head>
<body>
	<div>
		<!--<div class="pagecard" id="pagecard1">
			<p style="text-align:center;font-size:20px;display: none;"><b>趋势对比</b></p>
		</div>-->
		<div style="text-align:left;padding-left: 10px;">
			<span><label class="title-right">类别分组：</label></span>
			<span class="dropdown" style="position: relative;" >
			<!--<button class="btn btn-default dropdown-toggle form-control select_multiple" style="width: 90px;margin-left: 0px;" type="button" id="dropdownMenu21" data-toggle="dropdown">
				<span class="select_text" data-is-select="false">Dro pup</span>
				<span class="caret"></span>
			</button>-->
			<label class="dropdown-toggle select_multiple" data-toggle="dropdown">
				<input id="select_text" class="select_text " data-is-select="false" style="height:35px;line-height: 30px;color:black;border-radius: 5px;">
				<button  style="width:30px;height:35px;margin-left:-35px;position: relative;z-index: 2;"><i class= "caret">
				</i></button></input>
				<!--<a  class="btn  btn-default" href = "#" style="margin-left:-40px;"><i class= "caret">
                </i></a>-->
			</label>
			<ul class="dropdown-menu dropdown_item" style="bottom: auto;" id="display_type">
				<!--<li><label><input type="checkbox" class="check_box" value="aa" /> <span>越上限</span></label></li>
				<li><label><input type="checkbox" class="check_box" value="bb" /> <span>越下限</span></label></li>为了方便演示，type设置text了，实际中可以设置成hidden -->
			</ul><b style="font-size: 80%;color:red;margin-left:30px;">*选项类别不能大于4个</b>
			</span>
		</div>
		<div  style="text-align:left;padding-left: 10px;">
			<span><label class="title-right" >时间选择：</label></span>
			<span>
			<input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" id="cxsj" 
				style="width:130px;font-size:16px;height: 30px;border-radius: 5px;margin-right: 20px;"></input>
			<!--<label class="title-right">计量点名称：</label>
				<a id="refreshlist" class="glyphicon glyphicon-refresh" href="javascript:void(0)" onclick="refreshsensorslist()"></a>
					<select id="jcdd" style="font-size:18px;width:253px;vertical-align:-10%;" onchange="gradeChange()">display:none
				</select>-->
				<!--<input class="button" type="button" id="chaxun" value="对比" onclick="oneChoice()"
					style="font-size:16px;height: 30px;line-height: 30px;margin-left: 10px;"></input>
				<input class="button" type="button" id="allcheck" value="取消选择" onclick="allChoice()"
					style="font-size:16px;width:100px;height: 30px;line-height: 30px;"></input>-->
				<button class="selected" id="chaxun" value="对比" onclick="oneChoice()">对比</button>
					<a href="javascript:void(0)" style="margin-left:10px;" onclick="exporttoexcel('compratetable')">
						<img src="res/dcexcel.jpg" alt="Big Boat" title="导出到Excel" class="img-thumbnail img-responsive" style="width:40px;"></a>
				<label id="sel-sensorname"></label>
			</span>
			<form  id="jcdd" style="background-color: #dcdcdc;height: 500px;overflow: auto;font-size:16px;display:none;">
				<p><input type="checkbox" value="0" οnclick="allChoice()" id="allCheck" name="checks"/>全选 </p>
			</form>
		</div>
		<div class="container" style="text-align: center;width:100%;"><!--class="parent" class="column  MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 20px;flex:2.5;-->
			<div class="row" style="width: 100%;margin-top: 10px;padding-left: 50px;">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 "  style="margin-left: 0;margin-right: 0;" >
					<div class="row" align="center">
						<div id="chart1" class="col-xs-11 col-sm-11 displaytype1"  >
						</div>
						<div id="chart3" class="col-xs-11 col-sm-5"  style=" display: none;">
						</div>
					</div>
					<div class="row">
						<div id="chart2" class="col-xs-11 col-sm-5 "  style="display: none; ">
						</div>
						<div id="chart4" class="col-xs-11 col-sm-5"  style="display: none;">
						</div>
					</div>
				</div>
				<!--<div class="col-xs-12 col-sm-3 col-md-3 col-lg-3" id="fine" style="text-align: left; margin-left: 0;margin-right: 0;display:none">	
				</div>-->
			</div>
		</div>
		<div align="center" >
			<table id="compratetable" style="display: none;">
				<caption style="text-align: center;font-size:18px;">多点数据比对</caption>
				<tr id="table_title">
					<!--<th>编号</th>-->
					<th>测量点名称</th>
					<th>测量时间</th>
					<th>数值</th>	
					<th>备注</th>
				</tr>
				<tbody id='comprate-tbody' style="height:600px; overflow:auto;">
				</tbody>
			</table>
		</div>
	</div>
	<script>
		//初始化历史数据图形显示页面（在进入趋势图页面时触发）。
		var check_val = [],check_name=[];
		var kssj,jssj;
		var sensors,configs;
		var sel_str=[];
		var ch1,ch2,ch3,ch4;
		var cname,catalog;
		var isfound=false;
		var selectText="";
		var timer=null;
		var flashit=document.getElementById("chaxun");
		inithistorychart();
		function inithistorychart() {
			updatapcnav(7);
			sessionStorage.framepage="chart.html";
			//return;
			sessionStorage.pageindex = 4;
			ch1=document.getElementById("chart1");
			ch2=document.getElementById("chart2");
			ch3=document.getElementById("chart3");
			ch4=document.getElementById("chart4");
			var parentid = -100, parentname = "";
			var maps = [];
			document.getElementById("cxsj").value = (sessionStorage.cxsj).substr(0,11);
			if(sessionStorage.comperator_sensors)
			var sel_sensor =JSON.parse(sessionStorage.comperator_sensors);
			var tree_obj=window.parent.$("#tree_chi");
			var sensors=tree_obj.treeview("getUnselected");
			if(sensors && sel_sensor)
			for (var i = 0; i <sel_sensor.length; i++) {
				for(var j=0;j<sensors.length;j++){
					if(sel_sensor[i]==sensors[j].id){
						tree_obj.treeview("selectNode",sensors[j].nodeId);
						break;
					}
				}
			}
			//sensors=JSON.parse(localStorage.getItem("sensors"));//qck:>300 151-300 51-150 <50 >10000 5001-10000 2001-5000 <=2000 2 3-5 6-15 >15 500,500-1000,1000-3000,>3000,400,250,100,
			configs=JSON.parse(localStorage.Configs);
			/*if (sensors != null) {
				for (var i = 0; i < sensors.length; i++) {
					if ((sensors[i].Value.ParentId != "-1") && (sensors[i].Value.ParentId != parentid)) {
						parentid = sensors[i].Value.ParentId;
						for (var j = 0; j < sensors.length; j++) {
							if (sensors[j].id == parentid) {
								parentname = sensors[j].Value.Name + "_";
								break;
							}
						}
					}
					var map = new Object();
					map.value = sensors[i].id;
					map.name = parentname + sensors[i].Value.Name;  manage foreign language forest
					maps.push(map);
				}
				var compare = function (obj1, obj2) {//zw20-12 zw32-12 zw43-12 
					var val1 = obj1.name;
					var val2 = obj2.name;
					return val1.localeCompare(val2);//隧道：人/普通车/危化车 1500/4 500/p -/w  501-1500/3 500/3  1501-3000/2 501-1500/2 >3000/1 >1500/1
				}
				maps.sort(compare);
				for (var k = 0; k < maps.length; k++) {//将标签添加到多选列表中 油：3-3*30  2-3*50 3-3*70  dan 50、30 
					var p = document.createElement("p");
					var lab=document.createElement("label");
					var input=document.createElement("input");
					input.setAttribute("type","checkbox");
					input.setAttribute("name","checks");
					input.setAttribute("id",maps[k].name);
					input.setAttribute("value",maps[k].value);
					input.setAttribute('onclick','itemclick(this)');
					var spn=document.createElement("span");
					spn.innerHTML=maps[k].name;
					lab.appendChild(input);
					lab.appendChild(spn);
					p.appendChild(lab);
					sel_sensor.appendChild(p);
				}
			}*/
			appenddisplaytype();
			//setSelectOption("jcdd", sessionStorage.SensorId);
			oneChoice();
		}
		//添加显示控制选项
		function appenddisplaytype(anodeid){
			selectText="";
			if(sessionStorage.selectText){
				sel_str=sessionStorage.selectText.split(";");
			}else{
				sel_str=[];
			}
			var temp=document.getElementById("display_type");
			allconfigs=JSON.parse(localStorage.Configs);
    		if(allconfigs){
				for(var ac in allconfigs){//如果有，读取其所有配置项
            		var s_des=allconfigs[ac].details;//如果有，读取其所有配置项
					for(var p in s_des){
						for(var i=0;i<temp.children.length;i++){//0721 edit 判断是否存在配置项，如果存在则跳过继续，不存在则添加;
							if((temp.children[i].children[0].children[0].value.toLowerCase()==s_des[p].name.toLowerCase())
								&&(temp.children[i].children[0].children[1].innerText.toLowerCase()==s_des[p].desc.toLowerCase())){
								isfound=true;
								break;
							}
						}
						if(isfound){
							isfound=false;
							for(var j=0;j<sel_str.length;j++){
								if(temp.children[i].children[0].children[1].innerText==sel_str[j]){
									temp.children[i].children[0].checked=true;
									break;
								}
							}
							continue;
						}//0721 edit/**/
						var li=document.createElement("li");
						var lab=document.createElement("label");
						//lab.setAttribute("style","margin-left:20px")
						var ainput=document.createElement("input");
						ainput.setAttribute("type","checkbox");
						ainput.setAttribute("name","checkbox");
						ainput.setAttribute("value",s_des[p].name);
						ainput.className="check_box";
						var spn=document.createElement("span");
						spn.innerHTML=s_des[p].desc;
						for(var j=0;j<sel_str.length;j++){
							if(sel_str[j]==s_des[p].desc){
								ainput.setAttribute("checked",true);
								break;
							}
						}
						lab.appendChild(ainput);
						lab.appendChild(spn);
						//lab.innerHTML='<input class="catalog" type="checkbox" name="options" value="'+s_des[p].Name+'" >'+s_des[p].Desc;
						li.appendChild(lab);
						temp.appendChild(li);
						//var title_th =document.createElement("th");
						//title_th.innerHTML=s_des[p].Desc;
						//document.getElementById("table_title").appendChild(title_th);
					}
				}
				if(sel_str.length==0){
					temp.children[0].children[0].children[0].checked=true;
					sel_str.push(temp.children[0].children[0].children[1].innerHTML);
				}
				for(var i=0;i<temp.children.length;i++){
					if(temp.children[i].children[0].children[0].checked==true){
						selectText=selectText+temp.children[i].children[0].children[1].innerHTML+";";
					}
				}
				if(selectText.charAt(selectText.length - 1)==";"){
					//去除末尾分号
					selectText=selectText.substring(0,selectText.length - 1);
					//selectVal=selectVal.substring(0,selectVal.length - 1);
				}
				if(selectText==""){
					selectText="请选择类别分组项"
				}
			}else{
				for(var i=temp.childNodes.length;i>0;i--)
				temp.removeChild(temp.childNodes[i-1]);
				selectText="没有可选项";
			}
			document.getElementById("select_text").value=selectText;
			showchartview(sel_str);
		}
	
		function itemclick(obj){//多选列表项的点击响应过程
			var allobj = $('[name="checks"]');
			var c=0;
			for(var k in allobj){
				if(allobj[k].checked){
					c++;
				}
			}
			if(c>6){
				obj.checked=false;
				alert("对比测量点不能大于6个!",info_showtime);
				showstateinfo("对比测量点不能大于6个");
			}
		}
		function refreshsensorslist() {
			window.parent.GetSensorsByNode(sessionStorage.nodeId);
		}
		function allChoice(){//取消选择项
			var obj = $('[name="checks"]');
			var btn=document.getElementById("allcheck")
			//if(btn.value=="全选"){
			//	for(var i=0;i<obj.length;i++){
			//		obj[i].checked=true;
			//	}
			//	btn.value="全不选";
			//}else{
				for(var i=0;i<obj.length;i++){
					obj[i].checked=false;
				}
			//	btn.value="全选";
			//}
		}
		//对比按钮
		function oneChoice(){
			stoptimer(timer);
			var obj = window.parent.$("#tree_chi").treeview("getSelected");
			$("#comprate-tbody tr").remove();
			kssj=document.getElementById("cxsj").value+" 00:00:00"
			jssj=document.getElementById("cxsj").value+" 23:59:59"
			sessionStorage.cxsj=jssj;
			//var obj = $('[name="checks"]');
			check_name=[];check_val=[];
			for(var k=0;k<obj.length;k++){
				//if(obj[k].checked && obj[k].value != "-1"){
					check_val.push(parseInt(obj[k].id));
					check_name.push(obj[k].text);
				//}
			}
			sessionStorage.setItem("comperator_sensors", JSON.stringify(check_val));
			if(check_val.length>0){
				//sessionStorage.sensors
				var allobj = $('[name="checkbox"]');
				var pt=0;
				if(sel_str.length>0){
					for(var i=0;i<sel_str.length;i++){
						for(var j=0;j<allobj.length;j++){
							if(allobj[j].parentElement.outerText==sel_str[i]){
								cname=allobj[j].value;
								catalog=getcatalog(cname);
								pt++;
								gethistorybysensors(check_val,catalog,cname,pt,sel_str[i]);
							}
						}
					}
				}else{
					if(allobj.length>0){//是否有类别分组内容配置项
						layer.alert("请选择要显示的类别分组内容!",info_showtime);
						showstateinfo("请选择要显示的类别分组内容");
					}else{//没有配置项，传递空串，返回所有//20200520 add this function,need Verification; 
						gethistorybysensors(check_val,"","",1,"");
					}
				}
			}else{
				layer.alert("请选择要对比的测量点名称!",info_showtime);
				showstateinfo("请选择要对比的测量点名称!");
			}
		}
		/*function gethistorybysensors(arr_sensors,folder,aname,apt,atitle){
			var url = jfjk_base_config.baseurl + "GetHistoriesBySensors?folder="+folder+"&name="+aname+"&from="+kssj+"&to="+jssj;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("Authorization", sessionStorage.token);
					},
					url: url,
					type: 'POST',
					dataType: 'json',
					contentType: "application/json",
					data:JSON.stringify(arr_sensors),
					timeout: 10000,
					error: function(jqXHR, textStatus, errorThrown) {
						sessionStorage.errortime++;
						ajaxLoadingHidden();
						decodedatas([],apt,atitle);//
						//myChart.hideLoading();
						if (errorThrown == "Unauthorized") {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  未授权或授权已过期； 获取历史数据操作失败',info_showtime);
							showstateinfo(textStatus + ' :code' + jqXHR.status + '  未授权或授权已过期； 获取历史数据操作失败');
							LoginOrder(localStorage.username,sessionStorage.password,1)
						} else {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  ' + jqXHR.responseText + ' 获取历史数据操作失败',info_showtime);
							showstateinfo(textStatus + ' :code' + jqXHR.status + '  ' + jqXHR.responseText + ' 获取历史数据操作失败');
						}
						if(sessionStorage.errortime>3){
							sessionStorage.islogin=false;
							sessionStorage.errortime=0;
						}
					},
					success: function(data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)"); 
						ajaxLoadingHidden();
						if (status == "success") {
							sessionStorage.errortime = 0;
							sessionStorage.islogin = true;
							if (data.Error == null) {//Result.
								if (!jQuery.isEmptyObject(data.datas)) {
									showstateinfo("");
									decodedatas( data.datas,apt,atitle);
								} else {
									layer.alert("没有符合条件的 "+atitle+" 记录",info_showtime);
									showstateinfo("没有符合条件的 "+atitle+" 记录");
									decodedatas([],apt,atitle);//
								}
							} else {
								decodedatas([],apt,atitle);//
								layer.alert(data.Error,info_showtime);
								showstateinfo(data.Error);
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", info_showtime);
				showstateinfo("用户未登录，你无权完成此次操作");
			}
		}*/
		function gethistorybysensors(arr_sensors,folder,aname,apt,atitle){
			sendpostorder("GetHistoriesBySensors?folder="+folder+"&name="+aname+"&from="+kssj+"&to="+jssj,arr_sensors,function(data){
				if (data!= null) {//Result.
					if (!jQuery.isEmptyObject(data.datas)) {
						//showstateinfo("");
						decodedatas( data.datas,apt,atitle);
					} else {
						Alert("没有符合条件的 "+atitle+" 记录",info_showtime);
						showstateinfo("没有符合条件的 "+atitle+" 记录");
						decodedatas([],apt,atitle);//
					}
				} else {
					decodedatas([],apt,atitle);//
					Alert("没有符合条件的 "+atitle+" 记录",info_showtime);
					showstateinfo("没有符合条件的 "+atitle+" 记录");
				}
			})
		}
	//动态添加的元素注册添加点击事件//
	$(document).on("click",".check_box",function (event){
		event.stopPropagation();//阻止事件冒泡，防止触发li的点击事件
		//获取多选列表的所有选项内容。
		//勾选的项
		var $selectTextDom=$(this).parent().parent().parent("ul").siblings("label").children(".select_text");
		//勾选项的值
		//var $selectValDom=$(this).parent().parent().parent("ul").siblings(".select_val");
		//是否有选择项了
		var isSelected=$selectTextDom[0].getAttribute("data-is-select");
		//文本值，用于显示
		//var selectVal=$selectValDom.val();//实际值，会提交到后台的
		var selected_text=$(this).siblings("span").text();//当次勾选的文本值
		var selected_val=$(this).val();//当次勾选的实际值
		//判断是否选择过
		if(isSelected=="true"){
			selectText=$selectTextDom.val();
		}
		if(selectText!=""&&selectText!="请选择类别分组项"&&selectText!="没有可选项"){
			if(selectText.indexOf(selected_text)>=0){//判断是否已经勾选过
				selectText=selectText.replace(selected_text,"").replace(";;",";");//替换掉
				//selectVal=selectVal.replace(selected_val,"").replace(",,",",");//替换掉
				//判断最后一个字符是否是分号
				if(selectText.charAt(selectText.length - 1)==";"){
					//去除末尾分号
					selectText=selectText.substring(0,selectText.length - 1);
					//selectVal=selectVal.substring(0,selectVal.length - 1);
				}
				//判断第一个字符是否是分号，是的话去掉。
				if(selectText.charAt(0)==";"){
					selectText=selectText.substring(1);
				}
			}else{
				selectText+=";"+selected_text;
				//selectVal+=","+selected_val;
			}
		}else{
			selectText=selected_text;
			//selectVal=selected_val;
		}
		$selectTextDom.val(selectText);
		sessionStorage.selectText=selectText;
		//$selectValDom.val(selectVal);
		if(selectText==""){
			$selectTextDom.val("请选择类别分组项");
			$selectTextDom[0].setAttribute("data-is-select","false");
			sel_str.length=0;
		}else{
			$selectTextDom[0].setAttribute("data-is-select","true");
			sel_str=selectText.split(";")
			showchartview(sel_str);
		}
		if(timer!=null)
			stoptimer(timer);
		timer=blinklink(flashit);
	})
	function showchartview(asel_str) {
		switch(asel_str.length){
			case 1:
				ch1.className="col-xs-11 col-sm-11 displaytype1";
				ch2.setAttribute("style","display:none");
				ch3.setAttribute("style","display:none");
				ch4.setAttribute("style","display:none");
				break;
			case 2:
				ch1.className="col-xs-11 col-sm-11 displaytype2";
				ch2.className="col-xs-11 col-sm-11 displaytype2";
				ch2.setAttribute("style","display:block");
				ch3.setAttribute("style","display:none");
				ch4.setAttribute("style","display:none");
				break;
			case 3:
				ch1.className="col-xs-11 col-sm-5 displaytype2";
				ch3.className="col-xs-11 col-sm-5 displaytype2";
				ch3.setAttribute("style","display:block");
				ch2.className="col-xs-11 col-sm-5 displaytype2";
				ch2.setAttribute("style","display:block");
				ch4.setAttribute("style","display:none");
				break;
			case 4:
				ch1.className="col-xs-11 col-sm-5 displaytype2";
				ch3.className="col-xs-11 col-sm-5 displaytype2";
				ch3.setAttribute("style","display:block");
				ch2.className="col-xs-11 col-sm-5 displaytype2";
				ch2.setAttribute("style","display:block");
				ch4.className="col-xs-11 col-sm-5 displaytype2";
				ch4.setAttribute("style","display:block");
				break;
			}
	  }
	</script>
</body>
</html>
<!--对比配置项根据标签进行动态添加以及去除重复项功能，页面根据对比项目自动进行动态调整显示图形视窗的功能，
	编写树形菜单的双击响应程序（采用选中与释放之间的时间作为标准进行判断，小于一定时间视为双击，视频预览添加通道双击打开再次双击关闭功能
	0727添加显示控制配置项的页面记忆功能，在节点不变的情况下，切换页面时记忆上次的选择项并显示响应的图表视图。
	按钮样式	
-->