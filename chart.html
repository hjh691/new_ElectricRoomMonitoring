<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<!--script src="js/zrender.min.js"></script-->
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script type="text/javascript" src="js/echarts.js"></script>
	<script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
	<link rel="stylesheet" href="css/electricroommonitoring.css" />
	<script type="text/javascript" src="js/layer/layer.js"></script>
	<title>趋势图</title>
	<script type="text/javascript" src="js/function.js"></script>
	<style>
		html,
		body,
		#main {
			width: 100%;
			height: 100%;
		}
		.title-right {
			width:100px;
		}
		input:checked + span {
			color: #337ab7;
			font-weight: bold;
		}
		*{
			margin:0px;
			padding:0px;
		}
    /**/
		th,td{
			border:1px solid black;
			text-align:center;
			line-height:center;
			width:200px;
			height:30px;
		}
		td{
			border:1px solid black;
			text-align:center;
			line-height:center;
		}
		* {
			margin: 0;
			padding: 0;
		}
		table {
			/*设置相邻单元格的边框间的距离*/
			border-spacing: 0;
			/*表格设置合并边框模型*/
			border-collapse: collapse;
			text-align: center;
		}
		/*关键设置 tbody出现滚动条height: 450px;overflow-y: scroll;*/
		table tbody {
			display: block;
		}
		table thead,
		tbody tr {
			display: table;
			table-layout: fixed;
		}
		/*关键设置：滚动条默认宽度是16px 将thead的宽度减16pxwidth: 100%;
		
		table thead {
			width: calc( tbody.width )
		}
		table thead th {
			background: #ccc;
		}*/
	</style>
</head>
<body>
	<div>
		<div class="pagecard" id="pagecard1">
			<p style="text-align:center;font-size:20px"><b>趋势对比</b></p>
		</div>
		<div class="parent" style="text-align: center;">
			<div class="column" id="main" align="center"
				style="background-color: #dcdcdc; height:600px;width:1000px;MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 20px;flex:2.5;">
			</div>
			<div class="column" id="fine" style="MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 10px;text-align: left;">
				<div sytle="text-align:left;float:left">
				<p><label class="title-right" >时间选择：</label><input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" id="cxsj" style="width:130px;font-size:16px;height: 30px;"></input>
				</p>
				<p><label class="title-right">计量点名称：</label>
					<a id="refreshlist" class="glyphicon glyphicon-refresh" href="javascript:void(0)" onclick="refreshsensorslist()"></a>
						<!--<select id="jcdd" style="font-size:18px;width:253px;vertical-align:-10%;" onchange="gradeChange()">
					</select>-->
					<input class="button" type="button" id="chaxun" value="对比" onclick="oneChoice()"
						style="font-size:16px;height: 30px;line-height: 30px;"></input>
					<input class="button" type="button" id="allcheck" value="取消选择" onclick="allChoice()"
						style="font-size:16px;width:100px;height: 30px;line-height: 30px;"></input>
						<a href="javascript:void(0)" style="margin-left:20px;" onclick="method5('compratetable')">导出Excel</a>
				</p>
				<form  id="jcdd" style="background-color: #dcdcdc;height: 550px;overflow: auto;font-size:16px;">
					<p><input type="checkbox" value="0" οnclick="allChoice()" id="allCheck" name="checks"/>全选 </p>
				</form>
				</div>
			</div>
		</div>
		<div align="center" >
			<table id="compratetable" style="display: none;">
				<caption style="text-align: center;font-size:18px;">多点数据比对</caption>
				<tr >
					<th>测量点名称</th>
					<th>测量时间</th>
					<th>数值</th>	
					<th>备注</th>
				</tr>
				<tbody id='comprate-tbody' style="width:1020px;height:600px; overflow:auto;">
				</tbody>
			</table>
		</div>
	</div>
	<script>
		//初始化历史数据图形显示页面（在进入趋势图页面时触发）。人之初性本善性相近习相远
		var check_val = [],check_name=[];
		var kssj,jssj;
		updatapcnav(7);
		inithistorychart();
		function inithistorychart() {
			//return;
			sessionStorage.pageindex = 4;
			var parentid = -100, parentname = "";
			var maps = [];
			document.getElementById("cxsj").value = (sessionStorage.cxsj).substr(0,11);
			var sel_sensor = document.getElementById("jcdd");
			for (var i = sel_sensor.length-1; i >= 0; i--) {
				sel_sensor.removeChild(sel_sensor.children[i]);
			}
			var sensors = JSON.parse(localStorage.getItem("sensors"));
			if (sensors != null) {
				for (var i = 0; i < sensors.length; i++) {
					if ((sensors[i].Value.ParentId != "-1") && (sensors[i].Value.ParentId != parentid)) {
						parentid = sensors[i].Value.ParentId;
						for (var j = 0; j < sensors.length; j++) {
							if (sensors[j].id == parentid) {
								parentname = sensors[j].Value.Name + "_";
								break;
							}
						}
					}
					var map = new Object();
					map.value = sensors[i].id;
					map.name = parentname + sensors[i].Value.Name;
					maps.push(map);
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.name;
					var val2 = obj2.name;
					if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}
				}
				maps.sort(compare);
				for (var k = 0; k < maps.length; k++) {
					var p = document.createElement("p");
					var lab=document.createElement("label");
					var input=document.createElement("input");
					input.setAttribute("type","checkbox");
					input.setAttribute("name","checks");
					input.setAttribute("id",maps[k].name);
					input.setAttribute("value",maps[k].value);
					var spn=document.createElement("span");
					spn.innerHTML=maps[k].name;
					lab.appendChild(input);
					lab.appendChild(spn);
					p.appendChild(lab);
					sel_sensor.appendChild(p);
				}
			}
			//setSelectOption("jcdd", sessionStorage.SensorId);
			//querychartvalue();
		}
		function refreshsensorslist() {
			window.parent.GetSensorsByNode(sessionStorage.nodeId);
		}
		function allChoice(){
			var obj = $('[name="checks"]');
			var btn=document.getElementById("allcheck")
			//if(btn.value=="全选"){
			//	for(var i=0;i<obj.length;i++){
			//		obj[i].checked=true;
			//	}
			//	btn.value="全不选";
			//}else{
				for(var i=0;i<obj.length;i++){
					obj[i].checked=false;
				}
			//	btn.value="全选";
			//}
		}
		//对比按钮
		function oneChoice(){
			kssj=document.getElementById("cxsj").value+" 00:00:00"
			jssj=document.getElementById("cxsj").value+" 23:59:59"
			sessionStorage.cxsj=jssj;
			var obj = $('[name="checks"]');
			check_name=[];check_val=[];
			for(k in obj){
				if(obj[k].checked && obj[k].value != "-1"){
					check_val.push(parseInt(obj[k].value));
					check_name.push(obj[k].id);
				}
			}
			if(check_val.length<10){
				/*$("#comprate-head tr").empty();
				var thead=document.getElementById("comprate-head");
				var tr=document.createElement("tr");
				var td1=document.createElement("td");
				td1.innerHTML="测量时间";
				tr.appendChild(td1);
				for(j=0;j<check_name.length;j++){
					var td=document.createElement("td");
					td.innerHTML=check_name[j];
					tr.appendChild(td);
				}
				thead.appendChild(tr);*/
				gethistorybysensors(check_val);
			}else{
				alert("选择的标签数量过多，请选择少于10个标签进行对比！")
			}
		}
		function gethistorybysensors(arr_sensors){
			var url = jfjk_base_config.baseurl + "/GetHistoriesBySensors?from="+kssj+"&to="+jssj;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'POST',
					dataType: 'json',
					contentType: "application/json",
					data:JSON.stringify(arr_sensors),
					timeout: 10000,
					error: function(jqXHR, textStatus, errorThrown) {
						sessionStorage.errortime++;
						ajaxLoadingHidden();
						decodedatas([]);//20200214,传一个空数组
						//myChart.hideLoading();
						if (errorThrown == "Unauthorized") {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  未授权或授权已过期； 获取历史数据操作失败');
						} else {
							layer.alert(textStatus + ' :code' + jqXHR.status + '  ' + jqXHR.responseText + ' 获取历史数据操作失败');
						}
						if(sessionStorage.errortime>3){
							sessionStorage.islogin=false;
							sessionStorage.errortime=0;
						}
					},
					success: function(data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						ajaxLoadingHidden();
						if (status == "success") {
							sessionStorage.errortime = 0;
							sessionStorage.islogin = true;
							if (data.Error == null) {
								if (!jQuery.isEmptyObject(data.Result.Datas)) {
									decodedatas( data.Result.Datas);
								} else {
									layer.alert("没有符合条件的记录",2000);
									decodedatas([]);//20200214,传一个空数组
								}
							} else {
								decodedatas([]);//20200214,传一个空数组
								layer.alert(data.Error);
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", 2000);
			}
		}
	</script>
</body>
</html>