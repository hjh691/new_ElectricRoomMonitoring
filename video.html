<!DOCTYPE html>
<html>
<head>
   <meta charset="utf-8"> 
   <title>视频预览</title>
   <link rel="stylesheet" href="css/bootstrap.min.css" />
   <link rel="stylesheet" href="css/preview.css" /> 
   <script  type="text/javascript" src="js/jquery-3.3.1.js"></script>
   <script src="js/bootstrap.js"></script>
   <script type="text/javascript" src="js/config.js"></script>
   <script type="text/javascript" src="js/function.js"></script>
   <script src="js/flv.js"></script>
    <script src="js/hls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pearplayer"></script>
    <script type="text/javascript" src="js/layer/layer.js"></script>
   <script src="js/DPlayer.min.js"></script>
</head>
<style>
</style>
<body >
    <!--h1-- class="btn btn-success btn-large"><i class="glyphicon glyphicon-user"></i>Hello, world!<li><a href="#tab3" data-toggle="tab">Html</a></li>
        <li><a href="#tab4" data-toggle="tab">javascript</a></li></!--h1 -->
    <!--<ul class="nav nav-tabs"><link rel="stylesheet" href="css/electricroommonitoring.css"/>
        <li class="active"><a href="#tab1" data-toggle="tab">预览</a></li>
        <li><a href="#tab2" data-toggle="tab">回放</a></li>
    </ul>-->
    <div class="tab-content"  allowfullscreen="true" >
        <div class="parent" >
            <div class="column" style="MARGIN-RIGHT: auto; MARGIN-LEFT: auto;flex:1.1;">
                <div id="dplayer" style="width:800px;height:600px;background-color: gray;">
                </div>
                <!--<div id="dplayer" style="width:400px;height:400px;background-color: gray;float:left">float: left;
                </div>
                <span><div id="dplayer" style="width:400px;height:400px;background-color: gray;float: left;">
                </div>
                <div id="dplayer" style="width:400px;height:400px;background-color: gray;float:left">
                </div></span>
                <video id="videoElement" name="videoElement" class="centeredVideo" controls autoplay width="90%" height="300">

                </video>-->
            </div>
            <div class="column" style="MARGIN-RIGHT: auto; MARGIN-LEFT: auto;flex:1;">
                <fieldset class="preview">
                    <legend >预览</legend>
                    <table cellpadding="5" cellspacing="3" border="0">
                        <tr>
                            <td class="tt">码流类型</td>
                            <td>
                                <select id="streamtype" class="sel">
                                    <option value="0">主码流</option>
                                    <option value="1">子码流</option>
                                    <!--<option value="3">第三码流</option>
                                    <option value="4">转码码流</option>-->
                                </select>
                            </td>
                            <td>
                                <button type="button"  value="开始预览" onclick="clickStartRealPlay();" ><span class="glyphicon glyphicon-play"></span><a href="javascript:void(0)">开始预览</a></button>
                                <button type="button"  value="停止预览" onclick="clickStopRealPlay();" ><span class="glyphicon glyphicon-stop"></span><a href="javascript:void(0)">停止预览</a></button>
                                <button ><span class="glyphicon glyphicon-camera"></span><a href="javascript:void(0)" id="pz"> 抓图</a></button>
                            </td>
                        </tr>
                        <!--<tr>
                            <td class="tt">
                                窗口分割数&nbsp;</td>
                            <td>
                                <select class="sel" onchange="changeWndNum(this.value);">
                                    <option value="1">1x1</option>
                                    <option value="2" selected>2x2</option>
                                </select>
                            </td>
                            <td>
                                <button ><span class="glyphicon glyphicon-camera"></span><a href="javascript:void(0)" id="pz"> 抓图</a></button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3"><button style="display: none;"><span class="glyphicon glyphicon-camera"></span><a href="javascript:void(0)" id="pz1"> 抓图</a></button>
                                <input type="button" class="btn" value="抓图" onclick="clickCapturePic();" />onclick="clickCapturePic();"
                                <input type="button" class="btn" value="开始录像" onclick="clickStartRecord();" />
                                <input type="button" class="btn" value="停止录像" onclick="clickStopRecord();" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <input type="button" class="btn2" value="启用电子放大" onclick="clickEnableEZoom();" />
                                <input type="button" class="btn2" value="禁用电子放大" onclick="clickDisableEZoom();" />
                                <input type="button" class="btn2" value="启用3D放大" onclick="clickEnable3DZoom();" />
                                <input type="button" class="btn2" value="禁用3D放大" onclick="clickDisable3DZoom();" />
                                <input type="button" class="btn" value="全屏" onclick="clickFullScreen();" />
                            </td>
                        </tr-->
                    </table>
                </fieldset>
                <fieldset class="clist">
                    <legend>设备列表</legend>
                    <form class="opinfo" id="sz_list"></form>
                </fieldset>
                <!--<fieldset class="playback" >
                    <legend>回放</legend>
                    <table width="100%" cellpadding="0" cellspacing="3" style="border:0">
                        <tr>
                            <td class="tt">开始时间</td>
                            <td>
                                <input id="starttime" type="text" class="txt" value="2013-12-10 00:00:00" />（时间格式：2013-11-11 12:34:56）
                            </td>
                        </tr>
                        <tr>
                            <td class="tt">结束时间</td>
                            <td>
                                <input id="endtime" type="text" class="txt" value="2013-12-11 23:59:59" />
                                <input type="button" class="btn" value="搜索" onclick="clickRecordSearch(0);" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="searchdiv">
                                    <table id="searchlist" class="searchlist" cellpadding="0" cellspacing="0" style="border:0"></table>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <input type="button" class="btn2" value="开始回放" onclick="clickStartPlayback();" />
                                <input type="button" class="btn2" value="停止回放" onclick="clickStopPlayback();" />
                                <input type="button" class="btn" value="倒放" onclick="clickReversePlayback();" />
                                <input type="button" class="btn" value="单帧" onclick="clickFrame();" />
                                <input id="transstream" type="checkbox" class="vtop" />&nbsp;启用转码码流
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <input type="button" class="btn" value="暂停" onclick="clickPause();" />
                                <input type="button" class="btn" value="恢复" onclick="clickResume();" />
                                <input type="button" class="btn" value="慢放" onclick="clickPlaySlow();" />
                                <input type="button" class="btn" value="快放" onclick="clickPlayFast();" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <input type="button" class="btn2" value="开始剪辑" onclick="clickStartRecord();" />
                                <input type="button" class="btn2" value="停止剪辑" onclick="clickStopRecord();" />
                                <input type="button" class="btn2" value="OSD时间" onclick="clickGetOSDTime();" />&nbsp;<input id="osdtime" type="text" class="txt" readonly />
                            </td>
                        </tr>
                    </table>
                </fieldset>-->
                <fieldset class="operate">
                    <legend>操作信息</legend>
                    <div id="opinfo" class="opinfo"></div>
                </fieldset>
               <!--<fieldset class="callback">
                    <legend>事件回调信息</legend>
                    <div id="cbinfo" class="cbinfo"></div>
                </fieldset>-->
            </div>
        </div>
        <!-- <div class="tab-pane " id="tab2"><img src="res/lock.png"></img></div>
        div class="tab-pane" id="tab3"><img src="res/on.png"></img></!--div>
        <div-- class="tab-pane" id="tab4">
            <img src="res/t1.jpg"></img>
        </div-->
    </div>
    <script>
        var sel_id,dp,isstop;
        //var player;
        //var element = document.getElementsByName('videoElement')[0];
        
        //$(function(){
        //    $(".tab a:last").tab("show");
        //})
        initpage();
        //初始化日期时间
        var szCurTime = dateFormat(new Date(), "yyyy-MM-dd");
        //$("#starttime").val(szCurTime + " 00:00:00");
        //$("#endtime").val(szCurTime + " 23:59:59");
        // 显示操作信息
        function showOPInfo(szInfo) {
            szInfo = "<div>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
            $("#opinfo").html(szInfo + $("#opinfo").html());
        }
        // 格式化时间
        function dateFormat(oDate, fmt) {
            var o = {
                "M+": oDate.getMonth() + 1, //月份
                "d+": oDate.getDate(), //日
                "h+": oDate.getHours(), //小时
                "m+": oDate.getMinutes(), //分
                "s+": oDate.getSeconds(), //秒
                "q+": Math.floor((oDate.getMonth() + 3) / 3), //季度
                "S": oDate.getMilliseconds()//毫秒
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (oDate.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }
        function initpage(){
            updatapcnav(4);
			var parentid = -100, parentname = "";
			var maps = [];
            var sel_sensor = document.getElementById("sz_list");
			for (var i = sel_sensor.length-1; i >= 0; i--) {
				sel_sensor.removeChild(sel_sensor.children[i]);
			}
			var sensors = JSON.parse(localStorage.getItem("sensors"));
			if (sensors != null) {
				for (var i = 0; i < sensors.length; i++) {
                    if(sensors[i].Value.ParentId=="-1")
                        continue;
                    if ((sensors[i].Value.ParentId != "-1") && (sensors[i].Value.ParentId != parentid)) {
						parentid = sensors[i].Value.ParentId;
						for (var j = 0; j < sensors.length; j++) {
							if (sensors[j].id == parentid) {
								parentname = sensors[j].Value.Name + "_";
								break;
							}
						}
					}
					var map = new Object();
					map.value = sensors[i].id;
					map.name = parentname + sensors[i].Value.Name;
					maps.push(map);
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.name;
					var val2 = obj2.name;
					if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}
				}
				maps.sort(compare);
				for (var k = 0; k < maps.length; k++) {
					var p = document.createElement("p");
					var lab=document.createElement("label");
					var input=document.createElement("input");
					input.setAttribute("type","radio");
					input.setAttribute("name","checks");
					input.setAttribute("id",maps[k].name);
                    input.setAttribute("value",maps[k].value);
                    input.setAttribute("onclick","getvalue(this)");
					var spn=document.createElement("span");
					spn.innerHTML=maps[k].name;
					lab.appendChild(input);
					lab.appendChild(spn);
                    p.appendChild(lab);
					sel_sensor.appendChild(p);
                }
                for(j=0;j<sel_sensor.length;j++){
                    if(sel_sensor[j].value==sessionStorage.sel_id){
                        sel_sensor[j].checked=true;
                        break;
                    }
                }
                if(typeof(sessionStorage.sel_id)=="undefined"||sessionStorage.sel_id<0||sessionStorage.sel_id==null){
                    sel_sensor[0].checked=true;
                }
            }
            /*element.addEventListener("pause",function(){
            showOPInfo("video暂停");
                player.play();
            })
            element.addEventListener("error",function(){
                if(!isstop)
                clickStartRealPlay();
            })*/
            if(sessionStorage.videourl==null||typeof(sessionStorage.videourl)=="undefined")
                sessionStorage.videourl='';
            if(sessionStorage.streamtype==null||typeof sessionStorage.streamtype=="undefined"){
                sessionStorage.streamtype=0;
            }
            setSelectOption("streamtype",sessionStorage.streamtype);
            //if(sessionStorage.videourl==""||typeof(sessionStorage.videourl)=="undefined")
                clickStartRealPlay();//解决窗口变化预览停止的问题。
                clickCapturePic();
        }
        /*dp = new DPlayer({
            container: document.getElementById('dplayer'),
            autoplay: true,
            theme: '#FADFA3',
            loop: true,
            lang: 'zh-cn',
            screenshot: true,
            hotkey: true,
            preload: 'auto',
            //logo: 'logo.png',
            volume: 0.7,
            mutex: false, 
            video: {
                url: sessionStorage.videourl,//'../mp401.flv',//"",//
                //pic: 'dplayer.png',
                //thumbnails: 'thumbnails.jpg',
                type: 'auto',
            },
            /*subtitle: {
                url: 'dplayer.vtt',
                type: 'webvtt',
                fontSize: '25px',
                bottom: '10%',
                color: '#b7daff',
            },
            danmaku: {
                id: '9E2E3368B56CDBB4',
                api: 'https://api.prprpr.me/dplayer/',
                token: 'tokendemo',
                maximum: 1000,
                addition: ['https://api.prprpr.me/dplayer/v3/bilibili?aid=4157142'],
                user: 'DIYgod',
                bottom: '15%',
                unlimited: true,
            },
            contextmenu: [
                {
                    text: 'custom1',
                    link: 'https://github.com/DIYgod/DPlayer',
                },
                {
                    text: 'custom2',
                    click: (player) => {
                        console.log(player);
                    },
                },
            ],
            highlight: [
                {
                    time: 20,
                    text: '这是第 20 秒',
                },
                {
                    time: 120,
                    text: '这是 2 分钟',
                },
            ],
        });*/
        function clickStartRealPlay(){
            if(typeof(dp)!=="undefined"&&dp!="null"){//解决多次之间点击开始预览按钮造成多播放线程的问题。//
                dp.pause();
                dp.destroy();
                isstop=true;
            }
            var radio=document.getElementsByName("checks");
            sel_id=0;
            for (i=0; i<radio.length; i++) {
                if (radio[i].checked) {
                    sel_id=(radio[i].value)
                    sessionStorage.sel_id=sel_id;
                }
            }
            sessionStorage.streamtype=document.getElementById("streamtype").value;
            if (typeof(sel_id) !=="undefined") {
                sessionStorage.videourl = jfjk_base_config.baseurl + "GetFlv?sensorId="+sel_id+"&type=0&channel="+sessionStorage.streamtype+"&_token="+sessionStorage.token;
                url = encodeURI(sessionStorage.videourl); //url='../mp401.flv';
                //url=
               /* if (typeof player !== "undefined"&&player!=null) {
                    if (player != null) {
                        player.unload();
                        player.detachMediaElement();
                        player.destroy();
                        player = null;
                    }
                }
                player = flvjs.createPlayer({
                    type: 'flv',
                    url: url,//'../mp401.flv',
                });
                player.attachMediaElement(element);
                player.load();
                player.play();*/
                dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    autoplay: true,//自动播放
                    theme: '#FADFA3',
                    loop: false,//循环播放
                    lang: 'zh-cn',
                    screenshot: true,//截屏
                    hotkey: false,
                    preload: 'auto',//预加载
                    //logo: 'logo.png',
                    volume: 0.7,
                    mutex: false, //多个视频同时播放
                    video: {
                        url: url,//
                        type: 'flv',
                    },
                });
                dp.on('play',function(){
                    //console.log("预览成功");
                    showOPInfo("开始预览成功")
                });
                dp.on("error" ,function(){
                    showOPInfo("视频预览错误");//播放
                    if(!isstop){
                        clickStartRealPlay();//解决视频加载失败或播放过程中出现错误而预览停止的问题
                    }
                });
                dp.on("pause",function(){
                    showOPInfo("暂停预览");
                    if(!isstop)
                        dp.play();//解决浏览器最小化或被遮挡后视频预览将暂停的问题。
                });
                dp.on("screenshot",function(){
                    showOPInfo("截屏");
                });
                isstop=false;
            }else{
                layer.alert("请选择要预览的通道");
            }
        }
        function clickStopRealPlay(){
            if(typeof(dp)!=="undefined"&&dp!="null"){
                isstop=true;
                dp.pause();
                dp.destroy();
                dp=undefined;
                sessionStorage.videourl="";
                sessionStorage.sel_id=-1;
                showOPInfo("停止预览成功")
            }
            /*if(typeof player !=="undefined"&&player!=null){
                isstop=true;
                player.pause();
                player.unload();
                player.destroy();
                player=null;
            }*/
            
        }
        function getvalue(obj){
            sel_id=obj.value;
        }
        function clickCapturePic(){
            var zhuavideo=document.getElementById("pz");
            zhuavideo.addEventListener('click', function() {
                const canvas = document.createElement("canvas");
                canvas.width = dp.video.videoWidth;
                canvas.height = dp.video.videoHeight;
                canvas.getContext('2d').drawImage(dp.video, 0, 0, canvas.width, canvas.height);
                zhuavideo.href = canvas.toDataURL();
                zhuavideo.download = "DPlayer.png";
            });
            //paizhao();
        }
        /*function paizhao(){
            var paizhao=document.getElementById("pz1");
            paizhao.addEventListener("click",function(){
                const canvas=document.createElement("canvas");
                canvas.width = player._mediaElement.videoWidth;
                canvas.height = player._mediaElement.videoHeight;
                canvas.getContext("2d").drawImage(player._mediaElement,0,0,canvas.width,canvas.height);
                paizhao.href=canvas.toDataURL();
                paizhao.download="flvplayer.png";
            })
        }*/
    </script>
</body>
</html>