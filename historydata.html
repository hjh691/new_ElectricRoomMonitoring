<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<link rel="stylesheet" href="css/electricroommonitoring.css"/>
	
	<title>历史数据</title>
	<script  type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/bootstrap.js" ></script>
	<script  type="text/javascript" src="js/config.js"></script>
	<script  type="text/javascript" src="js/layer/layer.js"></script>
	<script  type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
	<script  type="text/javascript" src="js/function.js"></script>
	<style>
	th,td{
        border:1px solid black;
        text-align:center;
        line-height:center;
        width:200px;
        height:30px;
    }
	table tbody {
		display: block;
	}
	table thead,
	tbody tr {
		display: table;
		table-layout: fixed;
	}
	</style>
</head>
<body >
	<div>
		<div class="pagecard" id="pagecard1" >
			<p style="text-align:center;font-size:20px" ><b>历史数据</b></p>
		</div>
		<div align="center"style="height:100px;overflow:auto;" >
			<div class="rowlay" style="width:100%;text-align: center;font-size:16px;vertical-align: -10%;">
				图形列表：
				<select id="jcdd" style="font-size:18px;width:153px;vertical-align:-10%;">
				<option value="0">测温0</option>
			</select><span class="glyphicon glyphicon-refresh" style="margin-left:20px;margin-right: 20px;" onclick="refreshsensorslist()"></span>
				起止时间0
			<input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss'})"  id="kssj_history" style="width:160px;font-size:16px;height: 30px;"></input>至
			<input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss'})"  id="jssj_history" style="width:160px;font-size:16px;height: 30px;" ></input>
			<input class="button" type="button" id="chaxun" value="查询" onclick="queryhistorydata()" style="font-size:16px;height: 35px;" ></input>
			</div>			
			<div  class="rowlay" style="margin-bottom:10px;width:100%;font-size:16px;text-align: center;" >
				<ul class="count_info" align="center" >
					<!--<li style="width:50px"><b>站名：</b></li>
					<li id="station_name"style="width:100px;margin-right:0px"> </li>-->
					<li style="width:50px;margin-right:0px"><b>标签名称：</b> </li>
					<li id="normal_count"style="width:100px;margin-right:10px"> </li>
					<li style="width:50px;margin-right:0px"><b>记录数：</b></li>
					<li id="count_val"style="width:50px;margin-right:0px"> </li>
					<li style="width:100px;margin-right:0px"><a href="javascript:void(0)" style="margin-left:20px;" onclick="method5('realtable')">导出Excel</a></li>
				</ul>
			</div>
		</div>
		<div align="center" >
		<table id="historytable" width="800px"  >
			<thead>
				<tr >
				<!--<th>测量点编号</th>-->
				<th>测量点名称</th>
				<th>测量时间</th>
				<th>峰值</th>
				<th>均值</th>	
				</tr>
			</thead>
			<tbody id='historydata-tbody'  style="width:823px;height:600px; overflow:auto;">
			</tbody>
		</table>
		</div>
	</div>
	<script>
		var xs=1;
		var sensors;
		var isfirst=true;
		initpage();

		function initpage(){
			document.getElementById("kssj_history").value = sessionStorage.kssj;
			document.getElementById("jssj_history").value = sessionStorage.jssj;
			var sel_sensor=document.getElementById("jcdd");
			for (var i = 0; i < sel_sensor.length; i++) {
				sel_sensor.removeChild(sel_sensor.options[0]);
				sel_sensor.remove(0);
				sel_sensor.options[0] = null;
			}
			sensors=JSON.parse(localStorage.getItem("sensors"));
			if(sensors!=null){
				for(var i=0;i<sensors.length;i++){
					var op=document.createElement("option");
					op.setAttribute("value",sensors[i].id);
					op.innerHTML=sensors[i].Value.Name;
					sel_sensor.appendChild(op);
				}
			}
			setSelectOption("jcdd", sessionStorage.SensorId);
			queryhistorydata();
		}
		function refreshsensorslist(){
			window.parent.GetSensorsByNode(sessionStorage.nodeId);
		}
		//查询历史记录
		function queryhistorydata() {
			var sel=document.getElementById("jcdd");
			if(sel.options.length<=0){
				layer.alert("请选择要查询的测量点名称");
				return;
			}
			var kssj = document.getElementById("kssj_history").value;
			if ((kssj == null) || (kssj == "") || (kssj == undefined)) {
				layer.alert("请指定开始时间");
				return;
			}
			var jssj = document.getElementById("jssj_history").value;
			if ((jssj == null) || (jssj == "") || (jssj == undefined)) {
				layer.alert("请指定截至时间");
				return;
			}
			if((sessionStorage.SensorId==sel.value)&&(sessionStorage.kssj==kssj)&&(sessionStorage.jssj==jssj)&&(!isfirst)){
				return;
			}
			sessionStorage.kssj = kssj;
			sessionStorage.jssj = jssj;
			sessionStorage.SensorId = sel.value;
			sessionStorage.SensorName = sel.options[sel.selectedIndex].text;
			xs=sensors[sel.selectedIndex].Value.Factor;
			$("#historydata-tbody tr").empty();
			
			gethistorydata(sessionStorage.SensorId,kssj, jssj);
			isfirst=false;
		}

		function decodedatas(obj_data){
			var count = 0;
			var maxvale=0,minvalue=0,avgvalue=0,ps=0,ct=1;
			var stime=new Date(sessionStorage.kssj).getTime();
			var etime=new Date(sessionStorage.jssj).getTime();
			var senconds=etime-stime;
			//数据以表格行的形式添加进table中，其实现隔行颜色区分。
			if(obj_data.length<=0){
				return;
			}
			if(Math.ceil(senconds/1000/60)<1430){
				for (var i = 0; i <obj_data.length; i++) {
					var tr = document.createElement('tr');
					if (i % 2 == 0) {
						tr.setAttribute('style', "background-color:#16b9c9");
					}
					var tdname = document.createElement('td');
					tdname.setAttribute('class', 'seneorname');
					var tdtime = document.createElement('td');
					tdtime.setAttribute('class', 'time');
					var tdvalue1 = document.createElement('td');
					tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
					var tdvalue2 = document.createElement('td');
					tdvalue2.setAttribute('class', 'value2');
					tdname.innerHTML=sessionStorage.SensorName;
					tdvalue1.innerHTML = obj_data[i].Value;

					//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
					tdtime.innerHTML = obj_data[i].Time; //jsonObject[i].color;
					tdvalue2.innerHTML = obj_data[i].Value;
					tr.appendChild(tdname);
					tr.appendChild(tdtime);
					tr.appendChild(tdvalue1);
					tr.appendChild(tdvalue2);
					var tbody = document.getElementById('historydata-tbody');
					tbody.appendChild(tr);
				}
				ps=obj_data.length;
			}else if(Math.ceil(senconds/1000/60)<2880){
				maxvale=minvalue=avgvalue=parseFloat(obj_data[0].Value);
				var strtime=obj_data[0].Time.substr(0,13);
				var temp=parseInt(strtime.substr(11));
				for (var i = 1; i <obj_data.length; i++) {
					if(parseInt(obj_data[i].Time.substr(11,13))==temp){
						if(parseFloat(obj_data[i].Value)>maxvale){
							maxvale=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minvalue){
							minvalue=parseFloat(obj_data[i].Value);
						}
						avgvalue=(parseFloat(avgvalue)+parseFloat(obj_data[i].Value));
						ct++;
					}else{
						avgvalue=(avgvalue/ct);
						var tr = document.createElement('tr');
						if (ps% 2 == 0) {
							tr.setAttribute('style', "background-color:#16b9c9");
						}
						var tdname = document.createElement('td');
						tdname.setAttribute('class', 'seneorname');
						var tdtime = document.createElement('td');
						tdtime.setAttribute('class', 'time');
						var tdvalue1 = document.createElement('td');
						tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
						var tdvalue2 = document.createElement('td');
						tdvalue2.setAttribute('class', 'value2');
						tdname.innerHTML=sessionStorage.SensorName;
						tdvalue1.innerHTML = maxvale;

						//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
						tdtime.innerHTML = strtime+":00"; //jsonObject[i].color;
						tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
						tr.appendChild(tdname);
						tr.appendChild(tdtime);
						tr.appendChild(tdvalue1);
						tr.appendChild(tdvalue2);
						var tbody = document.getElementById('historydata-tbody');
						tbody.appendChild(tr);
						maxvale=minvalue=avgvalue=parseFloat(obj_data[i].Value);
						strtime=obj_data[i].Time.substr(0,13);
						temp=parseInt(strtime.substr(11));
						ps++;
						ct=1;
					}
				}
				avgvalue=(avgvalue/ct);
				var tr = document.createElement('tr');
				if (ps% 2 == 0) {
					tr.setAttribute('style', "background-color:#16b9c9");
				}
				var tdname = document.createElement('td');
				tdname.setAttribute('class', 'seneorname');
				var tdtime = document.createElement('td');
				tdtime.setAttribute('class', 'time');
				var tdvalue1 = document.createElement('td');
				tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
				var tdvalue2 = document.createElement('td');
				tdvalue2.setAttribute('class', 'value2');
				tdname.innerHTML=sessionStorage.SensorName;
				tdvalue1.innerHTML = maxvale;

				//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
				tdtime.innerHTML = strtime+":00"; //jsonObject[i].color;
				tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
				tr.appendChild(tdname);
				tr.appendChild(tdtime);
				tr.appendChild(tdvalue1);
				tr.appendChild(tdvalue2);
				var tbody = document.getElementById('historydata-tbody');
				tbody.appendChild(tr);
			}else{
				maxvale=minvalue=avgvalue=parseFloat(obj_data[0].Value);
				var strtime=obj_data[0].Time.substr(0,10);
				var temp=parseInt(strtime.substr(8));
				for (var i = 1; i <obj_data.length; i++) {
					if(parseInt(obj_data[i].Time.substr(8,10))==temp){
						if(parseFloat(obj_data[i].Value)>maxvale){
							maxvale=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minvalue){
							minvalue=parseFloat(obj_data[i].Value);
						}
						avgvalue=(parseFloat(avgvalue)+parseFloat(obj_data[i].Value));
						ct++;
					}else{
						avgvalue=(avgvalue/ct);
						var tr = document.createElement('tr');
						if (ps% 2 == 0) {
							tr.setAttribute('style', "background-color:#16b9c9");
						}
						var tdname = document.createElement('td');
						tdname.setAttribute('class', 'seneorname');
						var tdtime = document.createElement('td');
						tdtime.setAttribute('class', 'time');
						var tdvalue1 = document.createElement('td');
						tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
						var tdvalue2 = document.createElement('td');
						tdvalue2.setAttribute('class', 'value2');
						tdname.innerHTML=sessionStorage.SensorName;
						tdvalue1.innerHTML = maxvale;

						//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
						tdtime.innerHTML = strtime; //jsonObject[i].color;
						tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
						tr.appendChild(tdname);
						tr.appendChild(tdtime);
						tr.appendChild(tdvalue1);
						tr.appendChild(tdvalue2);
						var tbody = document.getElementById('historydata-tbody');
						tbody.appendChild(tr);
						maxvale=minvalue=avgvalue=parseFloat(obj_data[i].Value);
						strtime=obj_data[i].Time.substr(0,10);
						temp=parseInt(strtime.substr(8));
						ps++;
						ct=1;
					}
				}
				avgvalue=(avgvalue/ct);
				var tr = document.createElement('tr');
				if (ps% 2 == 0) {
					tr.setAttribute('style', "background-color:#16b9c9");
				}
				var tdname = document.createElement('td');
				tdname.setAttribute('class', 'seneorname');
				var tdtime = document.createElement('td');
				tdtime.setAttribute('class', 'time');
				var tdvalue1 = document.createElement('td');
				tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
				var tdvalue2 = document.createElement('td');
				tdvalue2.setAttribute('class', 'value2');
				tdname.innerHTML=sessionStorage.SensorName;
				tdvalue1.innerHTML = maxvale;

				//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
				tdtime.innerHTML = strtime; //jsonObject[i].color;
				tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
				tr.appendChild(tdname);
				tr.appendChild(tdtime);
				tr.appendChild(tdvalue1);
				tr.appendChild(tdvalue2);
				var tbody = document.getElementById('historydata-tbody');
				tbody.appendChild(tr);
			}
			count =ps+1;//obj_data.length;
			document.getElementById('count_val').innerHTML = count + "条";
			//document.getElementById('station_name').innerHTML = sessionStorage.stationName;
			document.getElementById('normal_count').innerHTML = sessionStorage.SensorName;
		}
	</script>
</body>
</html>