<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<link rel="stylesheet" href="css/electricroommonitoring.css"/>
	
	<title>历史数据</title>
	<script  type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/bootstrap.js" ></script>
	<script  type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/echarts.js"></script>
	<script  type="text/javascript" src="js/layer/layer.js"></script>
	<script  type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
	<script  type="text/javascript" src="js/function.js"></script>
	<style>
	th,td{
        border:1px solid black;
        text-align:center;
        line-height:center;
        width:200px;
        height:30px;
    }
	table tbody {
		display: block;
	}
	table thead,
	tbody tr {
		display: table;
		table-layout: fixed;
	}
	span{
		margin-left:10px;
	}
	a:visited{
		color:red;
	}
	</style>
</head>
<body >
	<div >
		<div class="pagecard" id="pagecard1" >
			<p style="text-align:center;font-size:20px" ><b>历史数据</b></p>
		</div>
		<div align="center"style="height:80px;overflow:auto;" >
			<div class="rowlay" ><b>
				计量点名称：
				<select id="jcdd" onchange="gradeChange()">
				
			</select><a id="refreshlist" class="glyphicon glyphicon-refresh" href="javascript:void(0)" 
			onclick="refreshsensorslist()"></a>
			<span ><label><input type="radio" value="0" onclick="seletime(this)" name="timeselect" ></input>当天</label> </span>
			<span ><label><input type="radio" value="1" onclick="seletime(this)" name="timeselect"></input>昨天</label></span>
			<span ><label><input type="radio" value="2" onclick="seletime(this)" name="timeselect"></input>当月</label> </span>
			<span ><label><input type="radio" value="3" onclick="seletime(this)" name="timeselect"></input>上月</label></span>
			<span ><label><input type="radio" value="4" onclick="seletime(this)" name="timeselect"></input>自定义</label></span>
			<span id="timedefine" style="display: none;">
			起止时间
			<input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss'})"  id="kssj_history" 
			style="width:160px;font-size:16px;height: 30px;"></input>至
			<input type="text" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss'})"  id="jssj_history" 
			style="width:160px;font-size:16px;height: 30px;" ></input>
			<input class="button" type="button" id="chaxun" value="查询" onclick="queryhistorydata()" 
			style="font-size:16px;height: 30px;line-height: 30px;" ></input></b></span>
			</div>			
			<div  class="rowlay" >
				<ul class="count_info" align="center" >
					<!--<li style="width:50px"><b>站名：</b></li><a href="javascript:void(0)" 
				onclick="seletime(1)">昨天</a> 
					<li id="station_name"style="width:100px;margin-right:0px"> </li>-->
					<li style="width:50px;margin-right:0px"><b>标签名称：</b> </li>
					<li id="normal_count"style="width:100px;margin-right:10px"> </li>
					<li style="width:50px;margin-right:0px"><b>记录数：</b></li>
					<li id="count_val"style="width:50px;margin-right:0px"> </li>
					<li style="width:100px;margin-right:0px"><a href="javascript:void(0)" 
						style="margin-left:20px;" onclick="method5('historytable')">导出Excel</a></li>
				</ul>
			</div>
		</div>
		<div class="parent" style="text-align: center;">
		<div class="tab-head" id="tab-head" style="height: 40px">
		<div id="h2" class="selected" onclick="changetype();" style="width:100px;">数据列表</div>
		</div>
		<div class="column" align="center" id="list" style="display: none;MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 10px;">
		<table id="historytable" width="800px"  >
			<thead>
				<tr >
				<!--<th>测量点编号</th>点名称 -->
				<th>测量时间</th>
				<th>最大值</th>
				<th>平均值</th>
				<th>最小值</th>	
				</tr>
			</thead>
			<tbody id='historydata-tbody'  style="width:823px;height:600px; overflow:auto;">
			</tbody>
		</table>
		</div>
			<div class="column"  id="main" align="center" 
			style="height:500px;width:800px;MARGIN-RIGHT: auto; MARGIN-LEFT: auto;margin: 10px;margin: 20px;"></div>
		</div>
	</div>
	<script>
		var xs=1;
		var sensors;
		var isfirst=true;
		var sel_sensor=document.getElementById("jcdd");
		var type;
		var jssj=getCurrentDate(2);
		initpage();
		function initpage(){
			var parentid=-100,parentname="";
			var maps=[];
			document.getElementById("kssj_history").value = sessionStorage.kssj;
			document.getElementById("jssj_history").value = sessionStorage.jssj;
			for (var i = 0; i < sel_sensor.options.length; i++) {
				sel_sensor.removeChild(sel_sensor.options[0]);
				sel_sensor.remove(0);
				sel_sensor.options[0] = null;
			}
			sensors=JSON.parse(localStorage.getItem("sensors"));
			if(sensors!=null){
				for(var i=0;i<sensors.length;i++){
					if((sensors[i].Value.ParentId!="-1")&&(sensors[i].Value.ParentId!=parentid)){
						parentid=sensors[i].Value.ParentId;
						for(var j=0;j<sensors.length;j++){
							if(sensors[j].id==parentid){
								parentname=sensors[j].Value.Name+"_";
								break;
							}
						}
					}
					var map=new Object();
					map.value=sensors[i].id;
					map.name=parentname+sensors[i].Value.Name;
					maps.push(map);
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.name;
					var val2 = obj2.name;
					if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}            
				} 
				maps.sort(compare);
				for(var k=0;k<maps.length;k++){
					var op=document.createElement("option");
					op.setAttribute("value",maps[k].value);
					op.innerHTML=maps[k].name;
					sel_sensor.appendChild(op);
				}
				
			}
			$(":radio[name='timeselect'][value='"+sessionStorage.timeindex+"']").prop("checked","checked");
			setSelectOption("jcdd", sessionStorage.SensorId);
			queryhistorydata();
		}
		function refreshsensorslist(){
			window.parent.GetSensorsByNode(sessionStorage.nodeId);
		}
		function changetype(){
			var title=document.getElementById("h2");
			if(title.innerText=="数据列表"){
				document.getElementById("list").style.display="";
				document.getElementById("main").style.display="none";
				title.innerText="趋势图";
			}else if(title.innerText=="趋势图"){
				document.getElementById("list").style.display="none";
				document.getElementById("main").style.display="";
				title.innerText="数据列表";
			}
		}
		
		//查询历史记录
		function queryhistorydata() {
			for(var i=0;i<sensors.length;i++){
				if(sensors[i].id==sessionStorage.SensorId){
					type=sensors[i].Value.Catalog;
				}
			}
			var sel=document.getElementById("jcdd");
			if(sel.options.length<=0){
				layer.alert("请选择要查询的测量点名称");
				return;
			}
			var kssj = document.getElementById("kssj_history").value;
			if ((kssj == null) || (kssj == "") || (kssj == undefined)) {
				layer.alert("请指定开始时间");
				return;
			}
			var jssj = document.getElementById("jssj_history").value;
			if ((jssj == null) || (jssj == "") || (jssj == undefined)) {
				layer.alert("请指定截至时间");
				return;
			}
			if((sessionStorage.SensorId==sel.value)&&(sessionStorage.kssj==kssj)&&(sessionStorage.jssj==jssj)&&(!isfirst)){
				layer.alert("查询条件与上一次相同，请重新选择!")
				return;
			}
			sessionStorage.kssj = kssj;
			sessionStorage.jssj = jssj;
			sessionStorage.SensorId = sel.value;
			sessionStorage.SensorName = sel.options[sel.selectedIndex].text;
			xs=sensors[sel.selectedIndex].Value.Factor;
			$("#historydata-tbody tr").empty();
			
			gethistorydata(sessionStorage.SensorId,kssj, jssj);
			isfirst=false;
			document.getElementById("timedefine").style.display="none";
		}

		function decodedatas(obj_data){
			var count = 0;
			var maxvalue=0,minvalue=0,avgvalue=0,ps=0,ct=1,maxval=0,minval=0;
			var stime=new Date(sessionStorage.kssj).getTime();
			var etime=new Date(sessionStorage.jssj).getTime();
			var senconds=etime-stime;
			var pa = [],pb = [],pc = [];
			var jiange="";
			var myChart = echarts.init(document.getElementById('main'));
			myChart.clear();
			$("#historydata-tbody tr").empty();
			//数据以表格行的形式添加进table中，其实现隔行颜色区分。
			if((!obj_data)||(obj_data.length<=0)){
				document.getElementById('count_val').innerHTML = count + "条";
				//document.getElementById('station_name').innerHTML = sessionStorage.stationName;
				document.getElementById('normal_count').innerHTML = sessionStorage.SensorName;
				return;
			}
			/*if(Math.ceil(senconds/1000/60)<1430){
				for (var i = 0; i <obj_data.length; i++) {
					var tr = document.createElement('tr');
					if (i % 2 == 0) {
						tr.setAttribute('style', "background-color:#16b9c9");
					}
					var tdname = document.createElement('td');
					tdname.setAttribute('class', 'seneorname');
					var tdtime = document.createElement('td');
					tdtime.setAttribute('class', 'time');
					var tdvalue1 = document.createElement('td');
					tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
					var tdvalue2 = document.createElement('td');
					tdvalue2.setAttribute('class', 'value2');
					var tdvalue3=document.createElement("td");
					tdvalue3.setAttribute("class",'value3');
					tdname.innerHTML=sessionStorage.SensorName;
					tdvalue1.innerHTML = obj_data[i].Value;

					//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
					tdtime.innerHTML = obj_data[i].Time; //jsonObject[i].color;
					tdvalue2.innerHTML = obj_data[i].Value;
					tdvalue3.innerHTML= obj_data[i].Value;
					//tr.appendChild(tdname);
					tr.appendChild(tdtime);
					tr.appendChild(tdvalue1);
					tr.appendChild(tdvalue2);
					tr.appendChild(tdvalue3);
					var tbody = document.getElementById('historydata-tbody');
					tbody.appendChild(tr);
				}
				ps=obj_data.length;
			}else */if(Math.ceil(senconds/1000/60)<=1440){
				jiange="按小时统计";
				maxvalue=minvalue=avgvalue=parseFloat(obj_data[0].Value);
				maxval=minval=maxvalue;
				var strtime=obj_data[0].Time.substr(0,13);
				var temp=parseInt(strtime.substr(11));
				for (var i = 1; i <obj_data.length; i++) {
					if(parseInt(obj_data[i].Time.substr(11,13))==temp){
						if(parseFloat(obj_data[i].Value)>maxvalue){
							maxvalue=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minvalue){
							minvalue=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)>maxval){
							maxval=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minval){
							minval=parseFloat(obj_data[i].Value);
						}
						avgvalue=(parseFloat(avgvalue)+parseFloat(obj_data[i].Value));
						ct++;
					}else{
						avgvalue=(avgvalue/ct);
						var tr = document.createElement('tr');
						if (ps% 2 == 0) {
							tr.setAttribute('style', "background-color:#16b9c9");
						}
						var tdname = document.createElement('td');
						tdname.setAttribute('class', 'seneorname');
						var tdtime = document.createElement('td');
						tdtime.setAttribute('class', 'time');
						var tdvalue1 = document.createElement('td');
						tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
						var tdvalue2 = document.createElement('td');
						tdvalue2.setAttribute('class', 'value2');
						var tdvalue3=document.createElement("td");
						tdvalue3.setAttribute("class",'value3');
						tdname.innerHTML=sessionStorage.SensorName;
						if(type=="pd"){
							tdvalue1.innerHTML = minvalue.toFixed(Number_of_decimal);
							tdvalue3.innerHTML = maxvalue.toFixed(Number_of_decimal);
						}else{
							tdvalue1.innerHTML = maxvalue.toFixed(Number_of_decimal);
							tdvalue3.innerHTML = minvalue.toFixed(Number_of_decimal);
						}
						//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
						tdtime.innerHTML = strtime+":00"; //jsonObject[i].color;
						tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
						//tr.appendChild(tdname);
						tr.appendChild(tdtime);
						tr.appendChild(tdvalue1);
						tr.appendChild(tdvalue2);
						tr.appendChild(tdvalue3);
						var tbody = document.getElementById('historydata-tbody');
						tbody.appendChild(tr);
						pa.push([strtodatetime(strtime+":00"), maxvalue, ps])
						pb.push([strtodatetime(strtime+":00"), avgvalue.toFixed(Number_of_decimal), ps])
						pc.push([strtodatetime(strtime+":00"),minvalue , ps])
						maxvalue=minvalue=avgvalue=parseFloat(obj_data[i].Value);
						strtime=obj_data[i].Time.substr(0,13);
						temp=parseInt(strtime.substr(11));
						ps++;
						ct=1;
					}
				}
				avgvalue=(avgvalue/ct);
				var tr = document.createElement('tr');
				if (ps% 2 == 0) {
					tr.setAttribute('style', "background-color:#16b9c9");
				}
				var tdname = document.createElement('td');
				tdname.setAttribute('class', 'seneorname');
				var tdtime = document.createElement('td');
				tdtime.setAttribute('class', 'time');
				var tdvalue1 = document.createElement('td');
				tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
				var tdvalue2 = document.createElement('td');
				tdvalue2.setAttribute('class', 'value2');
				var tdvalue3=document.createElement("td");
				tdvalue3.setAttribute("class",'value3');
				tdname.innerHTML=sessionStorage.SensorName;
				if(type=="pd"){
					tdvalue1.innerHTML = minvalue.toFixed(Number_of_decimal);
					tdvalue3.innerHTML = maxvalue.toFixed(Number_of_decimal);
				}else{
					tdvalue1.innerHTML = maxvalue.toFixed(Number_of_decimal);
					tdvalue3.innerHTML = minvalue.toFixed(Number_of_decimal);
				}
				//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
				tdtime.innerHTML = strtime+":00"; //jsonObject[i].color;
				tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
				//tr.appendChild(tdname);
				tr.appendChild(tdtime);
				tr.appendChild(tdvalue1);
				tr.appendChild(tdvalue2);
				tr.appendChild(tdvalue3);
				var tbody = document.getElementById('historydata-tbody');
				tbody.appendChild(tr);
				pa.push([strtodatetime(strtime+":00"), maxvalue, ps])
				pb.push([strtodatetime(strtime+":00"), avgvalue.toFixed(Number_of_decimal), ps])
				pc.push([strtodatetime(strtime+":00"),minvalue , ps])
			}else{
				jiange="按日统计";
				maxvalue=minvalue=avgvalue=parseFloat(obj_data[0].Value);
				maxval=minval=maxvalue;
				var strtime=obj_data[0].Time.substr(0,10);
				var temp=parseInt(strtime.substr(8));
				for (var i = 1; i <obj_data.length; i++) {
					if(parseInt(obj_data[i].Time.substr(8,10))==temp){
						if(parseFloat(obj_data[i].Value)>maxvalue){
							maxvalue=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minvalue){
							minvalue=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)>maxval){
							maxval=parseFloat(obj_data[i].Value);
						}
						if(parseFloat(obj_data[i].Value)<minval){
							minval=parseFloat(obj_data[i].Value);
						}
						avgvalue=(parseFloat(avgvalue)+parseFloat(obj_data[i].Value));
						ct++;
					}else{
						avgvalue=(avgvalue/ct);
						var tr = document.createElement('tr');
						if (ps% 2 == 0) {
							tr.setAttribute('style', "background-color:#16b9c9");
						}
						var tdname = document.createElement('td');
						tdname.setAttribute('class', 'seneorname');
						var tdtime = document.createElement('td');
						tdtime.setAttribute('class', 'time');
						var tdvalue1 = document.createElement('td');
						tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
						var tdvalue2 = document.createElement('td');
						tdvalue2.setAttribute('class', 'value2');
						var tdvalue3=document.createElement("td");
						tdvalue3.setAttribute("class",'value3');
						tdname.innerHTML=sessionStorage.SensorName;
						if(type=="pd"){
							tdvalue1.innerHTML = minvalue.toFixed(Number_of_decimal);
							tdvalue3.innerHTML = maxvalue.toFixed(Number_of_decimal);
						}else{
							tdvalue1.innerHTML = maxvalue.toFixed(Number_of_decimal);
							tdvalue3.innerHTML = minvalue.toFixed(Number_of_decimal);
						}
						//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
						tdtime.innerHTML = strtime; //jsonObject[i].color;
						tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
						//tr.appendChild(tdname);
						tr.appendChild(tdtime);
						tr.appendChild(tdvalue1);
						tr.appendChild(tdvalue2);
						tr.appendChild(tdvalue3);
						var tbody = document.getElementById('historydata-tbody');
						tbody.appendChild(tr);
						pa.push([strtodatetime(strtime+":00"), maxvalue, ps])
						pb.push([strtodatetime(strtime+":00"), avgvalue.toFixed(Number_of_decimal), ps])
						pc.push([strtodatetime(strtime+":00"),minvalue , ps])
						maxvalue=minvalue=avgvalue=parseFloat(obj_data[i].Value);
						strtime=obj_data[i].Time.substr(0,10);
						temp=parseInt(strtime.substr(8));
						ps++;
						ct=1;
					}
				}
				avgvalue=(avgvalue/ct);
				var tr = document.createElement('tr');
				if (ps% 2 == 0) {
					tr.setAttribute('style', "background-color:#16b9c9");
				}
				var tdname = document.createElement('td');
				tdname.setAttribute('class', 'seneorname');
				var tdtime = document.createElement('td');
				tdtime.setAttribute('class', 'time');
				var tdvalue1 = document.createElement('td');
				tdvalue1.setAttribute('class', 'value1'); //给单元格添加类名属性
				var tdvalue2 = document.createElement('td');
				tdvalue2.setAttribute('class', 'value2');
				var tdvalue3=document.createElement("td");
				tdvalue3.setAttribute("class",'value3');
				tdname.innerHTML=sessionStorage.SensorName;
				if(type=="pd"){
					tdvalue1.innerHTML = minvalue.toFixed(Number_of_decimal);
					tdvalue3.innerHTML = maxvalue.toFixed(Number_of_decimal);
				}else{
					tdvalue1.innerHTML = maxvalue.toFixed(Number_of_decimal);
					tdvalue3.innerHTML = minvalue.toFixed(Number_of_decimal);
				}
				//tdename.innerHTML=data.Result[i].SensorName;//jsonObject[i].name;
				tdtime.innerHTML = strtime; //jsonObject[i].color;
				tdvalue2.innerHTML = avgvalue.toFixed(Number_of_decimal);
				
				//tr.appendChild(tdname);
				tr.appendChild(tdtime);
				tr.appendChild(tdvalue1);
				tr.appendChild(tdvalue2);
				tr.appendChild(tdvalue3);
				var tbody = document.getElementById('historydata-tbody');
				tbody.appendChild(tr);
				pa.push([strtodatetime(strtime+":00"), maxvalue, ps])
				pb.push([strtodatetime(strtime+":00"), avgvalue.toFixed(Number_of_decimal), ps])
				pc.push([strtodatetime(strtime+":00"),minvalue , ps])
			}
			count =ps+1;//obj_data.length;
			document.getElementById('count_val').innerHTML = count + "条";
			//document.getElementById('station_name').innerHTML = sessionStorage.stationName;
			document.getElementById('normal_count').innerHTML = sessionStorage.SensorName;
			var lengenddata = [];
			lengenddata.push("最大值");
			lengenddata.push("平均值");
			lengenddata.push("最小值");
			maxval=(maxval*1+(maxval-minval)*0.2).toFixed(Number_of_decimal);
			minval=(minval*1-(maxval-minval)*0.2).toFixed(Number_of_decimal);
			drawchart();
			function drawchart() {
				//var myChart = echarts.init(document.getElementById('main'));
				var option = {
					color: ['#FFFF00', '#FF0000','#00ff00'],//
					backgroundColor: '#d0d0d0',
					title : {
								text : document.getElementById("jcdd").options[document.getElementById("jcdd").selectedIndex].text+' 变化趋势图  ',
								x:"center",
								subtext:jiange+"   "+sessionStorage.kssj+"——"+sessionStorage.jssj,
								subtextStyle:{
									color: "#000",
								}
							},/**/
					tooltip: {
						trigger: 'item',
						formatter: function(params) {
							var date = new Date(params.value[0]);
							data = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' +
							 date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes();
							return data + '<br/>' + params.value[1];
						}
					},
					toolbox: {
						show: true,
						feature: {
							mark: {
								show: true
							},
							dataView: {
								show: true,
								readOnly: false
							},
							magicType: {
								show: true,
								type: ['line']
							},
							//, 'bar', 'stack', 'tiled'
							restore: {
								show: true
							},
							saveAsImage: {
								show: true
							}
						}
					},
					dataZoom: {
						show: true,
						start: 0
					},
					legend: {
						data: lengenddata,
						orient:"horizontal",//"vertical",
						x:'left',
						y:'30',
						//color: 'white',
					},
					grid: {
						y2: 80
					},
					xAxis: [{
						type: 'time',
						splitNumber: 10,
						axisLine: {
							lineStyle: {
								color: 'black',
								width: 2
							},
							onZero:false
						}
					}],
					yAxis: [{
						type: 'value',
						axisLine: {
							lineStyle: {
								color: 'black',
								width: 2
							}
						},
						min:minval,
						max:maxval,
					}],
					series: [/**/{
						name: lengenddata[0],//document.getElementById("jcdd").options[document.getElementById("jcdd").selectedIndex].text,
						type: 'line',
						showAllSymbol: true,
						symbolSize: 1,
						data: pa
					},
					{
						name: lengenddata[1],//document.getElementById("jcdd").options[document.getElementById("jcdd").selectedIndex].text+"177",
						type: 'line',
						showAllSymbol: true,
						symbolSize: 1,
						data: pb
					},
					{
						name: lengenddata[2],//document.getElementById("jcdd").options[document.getElementById("jcdd").selectedIndex].text+"最小值",
						type: 'line',
						showAllSymbol: true,
						symbolSize: 1,
						data: pc
					}/**/
					]
				};
				myChart.hideLoading();
				myChart.setOption(option);
			}
		}
		function gradeChange() {
			$("#historydata-tbody tr").empty();
			var objS = document.getElementById("jcdd");
			sessionStorage.SensorId = objS.options[objS.selectedIndex].value;
			gethistorydata(sessionStorage.SensorId,sessionStorage.kssj,sessionStorage.jssj);
		}
	</script>
</body>
</html>