<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<link rel="stylesheet" href="css/bootstrap-treeview.min.css" />
	<link rel="stylesheet" href="css/electricroommonitoring.css" />
	<title>机房监控</title>
	<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
	<script type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/layer/layer.js"></script>
	<script type="text/javascript" src="js/cvi_busy_lib.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/bootstrap-treeview.min.js"></script>
	<script type="text/javascript" src="js/function.js"></script>
</head>

<body>
	<!--onload="initIndex()""showusername()"<script  type="text/javascript" src="js/layer/layer.js"></script>-->
	<div class="header" id="header" style="height:80px;position:relative;overflow: auto;">
		<div class="topbar" id="topbar">
			<div id="app_name"
				style="position:relative;float:left;left:15px;font-size:30px;font-style:bold;color:white"><i></i></div>
			<span id="img_yonghu" style="position:relative;float:left;left:40px">
				<!--No.2登录用户名显示/未登录-->
				<img src="res/caisetouxiang.png" width="20px" height="20px">
			</span>
			<!--end No.2-->
			<span id="yhname" style="position:relative;float:left;left:50px;color:white;font-size:12px;">
				<!--No.1登录用户名显示/未登录-->
				未登录
			</span>
			<!--end No.1value="系统设置"-->

			<span id="yhout" style="position:relative;float:left;left:80px;color:white;font-size:12px;"><a
					href="javascript:void(0)" style="color:white;">[登录]</a></span>
			<input type="button" class="topbar-bigbutton" value="联系我们"
				style="background:url(res/home.jpg) no-repeat center top;margin-top:10px;"
				onclick="showcontactus()"></input>
			<input type="button" class="topbar-bigbutton" value="APP下载"
				style="background:url(res/chilun.jpg) no-repeat center top;margin-top:10px;" onclick="showdownload()">

			</input>
			<!--<input type="button"  class="topbar-bigbutton" value="数据浏览" style="background:url(res/sanse.jpg) no-repeat center top;margin-top:10px;"></input>-->
			<input type="button" class="topbar-bigbutton" value="操作指南"
				style="background:url(res/bar.jpg) no-repeat center top;margin-top:10px;" onclick="showhelp()"></input>

		</div>
		<hr style="display:none" />
	</div>
	<!--header-->
	<!--  内容  -->
	<div id="chuangti" style="position: relative;">
		<!--左侧站名列表 <h4 id="head_list_name" align="left"  >变电站:</h4>-->
		<div class="leftmenu" id="leftmenu" style="float:left;width:15%;overflow:auto;min-width:200px;">

			<div id="tree" style="width:400px;overflow:auto;">

			</div>
		</div>
		<div id="content" style="overflow: hidden;">

			<!-- 导航栏 -->
			<div class="navigation" style="vertical-align:center;overflow:auto">
				<div class="row-navigation" style="vertical-align:center;min-width:500px;text-align:center">
					<ul class="pc-nav">
						<li><a href="javascript:void(0)" onclick="inittotalpage()">信息总览</a></li>
						<li><a href="javascript:void(0)" onclick="initdrawing()" id="realstate">状态图</a></li>
						<li><a id="realdata" href="javascript:void(0)" onclick="initrealdata()">实时数据</a></li>
						<li><a id="historydata" href="javascript:void(0)" onclick="loadstations_historydata()">历史数据</a>
						</li>
						<li><a id="historychart" href="javascript:void(0)" onclick="loadstations_chart()">趋势对比</a></li>
						<li><a href="javascript:void(0)" onclick="loadstations_warnlog()">告警信息</a></li>
						<li><a href="device.html" target="iframe_main">设备信息</a></li>
						<!--target="iframe_main"realwarning.html-->
						<li><a href="javascript:void(0)"  >系统设置</a></li>
						<!--<li ><a href="help.html" target="iframe_main" >使用指南</a></li>
							<li ><a href="ContactUs.html" target="iframe_main">联系我们</a></li>target="iframe_main"-->
					</ul>
				</div>
			</div>

			<div class="mainarea" id="mainarea">
				<iframe name="iframe_main" id="iframe_main" style="width:100%;height:99%" frameborder="0">
				</iframe>
				<table id="warningtable" style="display:none">
					<thead>
						<tr>
							<th>测量点编号</th>
							<th>测量点名称</th>
							<th>测量时间</th>
							<th>数值</th>
							<th>告警信息</th>
							<!--<th style="width:18px;border:0px solid black;"></th>-->
						</tr>
					</thead>
					<tbody id='realwarningdata-tbody'>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!--底部公司版权 -->
	<div>
		<!--<div class="navigation" id="footer" style="height:30px;position: absolute;bottom:0px;left:0px;right:0px;">	
			<div class="pc-footer" >
				<ul class="pc-footer" align="center" style="margin:0 150px;">
					<li ><a id="company_info" href="" target="_blank" ><img id="company_log" src="" width="20px" height="20px" > 保定金凯澳自动化设备有限公司</a></li>
					<li ><a href="#" style="margin-left:500px" >实时告警窗口</a></li>display: none;
				</ul>
			</div>
		</div>-->
		<!--告警信息悬浮窗style="display:none"-->
		<div id="KeFuDiv" class="KeFuDiv" onmousedown="hidefudongdiv();" >
			<!--屏幕滚动设置 <div class="affiche_text" id="alert_info">style="display: none;"
			</div>
			 <marquee id="affiche" align="middle" behavior="scroll"  direction="left" height="50" width="500" hspace="100" vspace="50" loop="-1" scrollamount="10" scrolldelay="100" onMouseOut="this.start()" onMouseOver="this.stop()" ></marquee>-->
			<div id="alert_info" style="vertical-align:center;background-color: rgba(255,255,0,0.2);">
			</div>

		</div>
		<!--KeFuDiv endhttp://tts.baidu.com/text2audio?lan=zh&ie=UTF-8&spd=6&text=<embed height="0" width="0" src="">-->
		<div id="wrapSpk">
			<audio id="spkAudio">
				<source src="" type="audio/wav">

			</audio>
			<textarea id="chatData" style="width:300px;height:40px;display:none" onclick="spack()" ;>asd
			</textarea>
		</div>
		<div id="audio">
		</div>
	</div>
	<script>
		var infotreedata = [], maps = [];
		var infotreeobj = new Object();
		var allsensors = null;
		var nodes = null, nodeid = -1;
		//滚动插件实现，只用于横向滚动。
		(function ($) {
			$.fn.extend({
				roll: function (options) {
					var defaults = {
						speed: 1
					};
					var options = $.extend(defaults, options);
					var speed = (document.all) ? options.speed : Math.max(1, options.speed - 1);
					if ($(this) == null) return;
					var $container = $(this);
					var $content = $("#alert_info");
					var init_left = $container.width();
					$content.css({ left: parseInt(init_left) + "px" });
					var This = this;
					var time = setInterval(function () { This.move($container, $content, speed); }, 20); //setInterval会改变this指向，即使加了This=this，也要用匿名函数封装，这里调试了n久

					$container.bind("mouseover", function () {
						clearInterval(time);
					});
					$container.bind("mouseout", function () {
						time = setInterval(function () { This.move($container, $content, speed); }, 20);
					});

					return this;
				},
				move: function ($container, $content, speed) {
					var fdck = document.getElementById("KeFuDiv");
					if (fdck.style.display == "none") { return }

					var container_width = $container.width();
					var content_width = $content.width();
					if (parseInt($content.css("left")) + content_width > 0) {
						$content.css({ left: parseInt($content.css("left")) - speed + "px" });
					}
					else {
						$content.css({ left: parseInt(container_width) + "px" });
						fdck.style.display = "none";
					}
				}
			});
		})(jQuery);
		$(document).ready(
			function () {
				$("#KeFuDiv").roll({ speed: 3 });//字幕滚动

				if (typeof (Worker) !== "undefined") {//定时器多任务
					if (typeof (w) == "undefined") {
						w = new Worker("delay_worker.js");
					}
					i = 0;
					w.onmessage = function (event) {//接收定时器返回的消息
						//document.getElementById("result").innerHTML = event.data;
						i++
						if (i % 60 == 0) {
							//sendbeat();//getrealsbydataid();
							getrealdatabynodeid(-1);
							//GetBinariesByType("NodeGraphic",sessionStorage.nodeId);
						}
					};
				} else {
					//document.getElementById("result").innerHTML = "抱歉，你的浏览器不支持 Web Workers...";
					var t1 = window.setInterval(sendbeat, 3000);//getrealsbydataid
				}
				//initIndex();
				refreshwindow();
			}
		);
		function refreshwindow() {//重画窗口，规定 尺寸,尤其是浮动窗口的位置
			sessionStorage.framepage = document.getElementById("iframe_main").src;
			var bodyfrm = (document.compatMode.toLowerCase() == "css1compat") ? document.documentElement : document.body;
			var fdheight = document.getElementById("KeFuDiv").offsetHeight;
			var fdwidth = document.getElementById("KeFuDiv").offsetWidth;
			var main = document.getElementById("chuangti");
			var header = document.getElementById("header");
			var menu = document.getElementById("leftmenu");
			var content = document.getElementById("content");
			//var footer = document.getElementById("footer");
			//isfree="true";
			//获取窗口宽度
			if (window.innerWidth)
				winWidth = window.innerWidth;
			else if ((document.body) && (document.body.clientWidth))
				winWidth = document.body.clientWidth;
			//获取窗口高度
			if (window.innerHeight)
				winHeight = window.innerHeight;
			else if ((document.body) && (document.body.clientHeight))
				winHeight = document.body.clientHeight;
			//初始位置
			var top = bodyfrm.scrollTop + bodyfrm.clientHeight - fdheight - 10;
			document.getElementById("KeFuDiv").style.top = top + 'px';////document.getElementById("KeFuDiv").offsetHeight)-30;
			var left = bodyfrm.scrollLeft + bodyfrm.clientWidth - fdwidth;//document.getElementById("KeFuDiv").offsetWidth)-17;;
			// (winHeight - document.getElementById("KeFuDiv").offsetHeight)-30 +"px";
			document.getElementById("KeFuDiv").style.left = left + 'px';//(winWidth - 
			document.getElementById("KeFuDiv").style.display="none";
			var m = (/MSIE [67]/.test(navigator.userAgent) && (event.type == "load")) ? 1 : 2;
			if (/MSIE [567]/.test(navigator.userAgent)) {
				var fwidth = main.offsetWidth;
				/*if(footer.style.borderWidth){
					fwidth -= m * footer.style.borderWidth.replace("px","");
				}
				footer.style.width = fwidth + "px";*/
			}
			var height = winHeight - main.offsetTop;//footer.offsetTop 
			if (main.style.borderWidth) {
				height -= m * main.style.borderWidth.replace("px", "");
			}
			if (height > 0) {
				main.style.height = height + "px";
				var mheight = height;
				if (menu.style.borderWidth) {
					mheight -= m * menu.style.borderWidth.replace("px", "");
				}
				if (mheight > 0) {
					menu.style.height = mheight + "px";
				}
				mheight = height;
				if (content.style.borderWidth) {
					mheight -= m * content.style.borderWidth.replace("px", "");
				}
				if (mheight > 0) {
					content.style.height = mheight + "px";
				}
			}
			initIndex();
		}
		window.onresize = window.onscroll = refreshwindow;//  
		//index页面初始化window.onload=
		function initIndex() {
			showusername();
			document.getElementById('app_name').innerHTML = '<i>' + jfjk_base_config.app_name + "</i>";
			//document.getElementById('company_log').src = jfjk_base_config.log_src;
			//document.getElementById('company_info').href = jfjk_base_config.company_url;
			sessionStorage.kssj = getCurrentDate(1) + " 00:00:00"; //"2012-09-03T08:00:00";//;
			sessionStorage.jssj = getCurrentDate(2); //"2012-09-05T08:00:00";//+ " 23:59:59"
			//sessionStorage.pageindex = 1;
			//getgraphics();
			//document.getElementById("iframe_main").src = 'page1.html';
			if (sessionStorage.islogin) {
				getNodes();
			} else {
				inittreeview();
			}
			if (sessionStorage.framepage == "") {
				sessionStorage.pageindex = 2;
				document.getElementById("iframe_main").src = "realdata.html"
			} else {
				document.getElementById("iframe_main").src = sessionStorage.framepage;
			}

		}
		//初始化目录树
		function inittreeview(anodes) {
			//var obj=tree[1];
			//obj.nodes=(JSON.parse( node));
			//tree[1]=obj;
			var mnodes = [];
			if (anodes == null) {
				mnodes = buildnode();
			} else {
				mnodes = anodes;
			}
			$('#tree').treeview({
				data: mnodes,    // 数据源
				showCheckbox: false,   //是否显示复选框
				highlightSelected: true,    //是否高亮选中
				nodeIcon: 'glyphicon glyphicon-user',    //节点上的图标 glyphicon-stats
				//nodeIcon: 'glyphicon glyphicon-lock',
				emptyIcon: '',    //没有子节点的节点图标
				enableLinks: true,//必须在节点属性给出href属性
				multiSelect: false,    //多选
				searchResultColor: "black",
				//color: "", //所有节点使用的默认前景色，这个颜色会被节点数据上的Color属性覆盖.        String
				//backColor: "#000000", //所有节点使用的默认背景色，这个颜色会被节点数据上的backColor属性覆盖.     String
				//borderColor: "#000000", //边框颜色。如果不想要可见的边框，则可以设置showBorder为false。        String
				//nodeIcon: "glyphicon glyphicon-stop", //所有节点的默认图标
				//checkedIcon: "glyphicon glyphicon-check", //节点被选中时显示的图标         String
				//collapseIcon: "glyphicon glyphicon-minus", //节点被折叠时显示的图标        String
				//expandIcon: "glyphicon glyphicon-plus", //节点展开时显示的图标        String
				//emptyIcon: "glyphicon", //当节点没有子节点的时候显示的图标              String
				//enableLinks: false, //是否将节点文本呈现为超链接。前提是在每个节点基础上，必须在数据结构中提供href值。        Boolean
				//highlightSearchResults: true, //是否高亮显示被选中的节点        Boolean
				//levels: 2, //设置整棵树的层级数  Integer
				//multiSelect: false, //是否可以同时选择多个节点      Boolean
				//onhoverColor: "#F5F5F5", //光标停在节点上激活的默认背景色      String
				//selectedIcon: "glyphicon glyphicon-stop", //节点被选中时显示的图标     String
				//searchResultBackColor: "", //当节点被选中时的背景色
				//searchResultColor: "", //当节点被选中时的前景色
				//selectedBackColor: "", //当节点被选中时的背景色
				//selectedColor: "#FFFFFF", //当节点被选中时的前景色
				//showBorder: true, //是否在节点周围显示边框
				//showCheckbox: false, //是否在节点上显示复选框
				//showIcon: true, //是否显示节点图标
				//showTags: false, //是否显示每个节点右侧的标记。前提是这个标记必须在每个节点基础上提供数据结构中的值。
				//uncheckedIcon: "glyphicon glyphicon-unchecked", //未选中的复选框时显示的图标，可以与showCheckbox一起使用
				//onNodeChecked: function (event,data) {
				//	console.log("nodeId = "+data.nodeId);
				//	console.log("id = "+data.id);
				//},
				onNodeSelected: function (event, data) {//目录树节点选中事件--提取对应id，获取旗下标签
					//var selectnode=$("#tree").treeview('getSelected');
					$("#tree").treeview('collapseAll')//,nodeid);//关闭展开
					sessionStorage.name = data.nodeId;
					if (data.level <= 2) {
						maps = [];
						infotreedata = [];
						infotreeobj = {};
						infotreeobj.id = data.id;
						infotreeobj.name = data.text;

						infotreeobj.children = [];
						infotreeobj.level = data.level;
						//infotreeobj.isload="false";
						if ((data.hasOwnProperty("nodes")) && (data.nodes.length > 0) && (data.level < 2)) {
							infotreeobj.value = data.nodes.length;
							infotreeobj.children = decode(data.nodes);
						} else {
							infotreeobj.value = 0;
						}
						infotreedata.push(infotreeobj);
						if (data.nodeId != nodeid && data.level <= 2) {
							localStorage.setItem("sensors", null);
							sessionStorage.nodeId = data.id;
							GetSensorsByNode(data.id);
							GetBinariesByType("NodeGraphic", sessionStorage.nodeId);
							sessionStorage.t_p = 0;
							nodeid = data.nodeId;
						}
						//iframe_main.window.num=0;
					} else {
						sessionStorage.SensorId = data.id;
						nodeid = data.nodeId;
						var p_node = getThe_level_nodeid(data, 2);
						sessionStorage.nodeId = p_node.id;
						GetSensorsByNode(sessionStorage.nodeId);
						GetBinariesByType("NodeGraphic", sessionStorage.nodeId);
						maps = [];
						infotreedata = [];
						infotreeobj = {};
						infotreeobj.id = data.id;
						infotreeobj.name = data.text;
						infotreeobj.level = data.level;

						//infotreeobj.value=0;
						infotreeobj.children = [];
						//infotreeobj.level=data.level;
						if ((data.hasOwnProperty("nodes")) && (data.nodes.length > 0)) {
							infotreeobj.value = data.nodes.length;
							var arr_node = buildsensor1(data.nodes);
							infotreeobj.value = arr_node.length;
							var sumnode = sumseneor(arr_node);
							for (var j in sumnode) {
								var ch1 = new Object();
								ch1.name = j;
								ch1.value = sumnode[j];
								infotreeobj.children.push(ch1);
							}
						} else {
							var temp = new Object();
							var leaf_name = data.Catalog;
							if (leaf_name == "null" || leaf_name == undefined || leaf_name.trim() == "") {
								leaf_name = "未定义"
							}
							temp.name = leaf_name;
							temp.value = 1;
							infotreeobj.value = 1;
							infotreeobj.children.push(temp);
						}
						infotreedata.push(infotreeobj);
					}
					for (var i = 0; i < data.level; i++) {//逐级展开所选节点的父节点。
						p_node = getThe_level_nodeid(data, i);
						$("#tree").treeview('expandNode', [p_node.nodeId, { levels: 1, silent: true }]);
					}
					$("#tree").treeview('expandNode', [data.nodeId, { levels: 1, silent: true }]);
				}
				/**方法
				 * checkAll(options);//选中所有树节点
				checkNode(node | nodeId, options);  //选中一个给定nodeId的树节点
				clearSearch();//清除查询结果
				collapseAll(options);//折叠所有树节点
				collapseNode(node | nodeId, options);//折叠一个给定nodeId的树节点和它的子节点
				disableAll(options);//禁用所有树节点
				disableNode(node | nodeId, options);//禁用一个给定nodeId的树节点
				enableAll(options);//激活所有树节点
				enableNode(node | nodeId, options);//激活给定nodeId的树节点
				expandAll(options);//展开所有节点
				expandNode(node | nodeId, options);//展开给定nodeId的树节点
				getCollapsed();//返回被折叠的树节点数组
				getDisabled();//返回被禁用的树节点数组
				getEnabled();//返回被激活的树节点数组  
				getExpanded();//返回被展开的树节点数组
				getNode(nodeId);//返回与给定节点id相匹配的单个节点对象。
				getParent(node | nodeId);//返回给定节点id的父节点
				getSelected();//返回被选定节点的数组。
				getSiblings(node | nodeId);//返回给定节点的兄弟节点数组
				getUnselected();//返回未选择节点的数组
				remove();//删除the tree view component.删除绑定的事件，内部附加的对象，并添加HTML元素。
				revealNode(node | nodeId, options);//显示给定的树节点，将树从节点扩展到根。
				search(pattern, options);//在树视图中搜索匹配给定字符串的节点，并在树中突出显示它们。返回匹配节点的数组。
				selectNode(node | nodeId, options);//选择一个给定的树节点
				toggleNodeChecked(node | nodeId, options);//Toggles a nodes checked state; checking if unchecked, unchecking if checked.
				toggleNodeDisabled(node | nodeId, options);//切换节点的禁用状态;
				toggleNodeExpanded(node | nodeId, options);//切换节点的展开与折叠状态
				toggleNodeSelected(node | nodeId, options);//切换节点的选择状态
				uncheckAll(options);//不选所有节点
				uncheckNode(node | nodeId, options);//不选给定nodeId的节点
				unselectNode(node | nodeId, options);//不选给定nodeId的节点
				事件：
				*nodeChecked (event, node) - 一个节点被checked.
				*nodeUnchecked (event, node) - 一个节点被unchecked.
				*nodeCollapsed (event, node) - 一个节点被折叠.
				*nodeDisabled (event, node) - 一个节点被禁用.
				*nodeEnabled (event, node) - 一个节点被启用.
				*nodeExpanded (event, node) - 一个节点被展开.
				*nodeSelected (event, node) - 一个节点被选择.
				*nodeUnselected (event, node) - 取消选择一个节点.
				*searchComplete (event, results) - 搜索完成之后触发.
				*searchCleared (event, results) - 搜索结果被清除之后触发.
				*/
			});
			$("#tree").treeview('collapseAll');//关闭展开
			if (sessionStorage.name == "" || sessionStorage.name == null) {
				sessionStorage.name = 0;//mnodes[0].text;//如果没有选择项，则选择第一项。
			}
			//var firstNode = $("#tree").treeview('search', [sessionStorage.name + "", { ignoreCase: false, exactMatch: false }]);//得到第一个节点//在页面尺寸变化时保持选项不变
			//if (firstNode[0].id != sessionStorage.nodeid) {
			//	nodeid = mnodes[0].id; sessionStorage.nodeid = firstNode[0].id;
			//} else {
			//保存nodeid，用于获取指定node的sensors。
			//	nodeid = firstNode[0].nodeId;
			//}
			var firstNode = $("#tree").treeview("getNode", sessionStorage.name);
			$("#tree").treeview('expandNode', [firstNode, { levels: 2, silent: true }]);//展开第一个节点
			for (var i = 0; i < firstNode.level; i++) {//逐级展开所选节点的父节点。
				var p_node = getThe_level_nodeid(firstNode, i);
				$("#tree").treeview('expandNode', [p_node.nodeId, { levels: 1, silent: true }]);
			}
			$("#tree").treeview('expandNode', [firstNode.nodeId, { levels: 1, silent: true }]);
			//$('#tree').treeview('expandNode', [ tree[0].id, { levels: 2, silent: true } ]);
			$('#tree').treeview('selectNode', [firstNode, { silent: true }]);
			//$("#tree").treeview("selectNode", firstNode);//将第一个节点设置为选中状态**
			//获取指定node的sensors
			//GetSensorsByNode(sessionStorage.nodeid);
			infotreedata = [];
			infotreeobj.id = firstNode.id;
			infotreeobj.name = firstNode.text;
			if (firstNode.hasOwnProperty("nodes")) {
				infotreeobj.value = firstNode.nodes.length;
			} else {
				infotreeobj.value = 0;
			}
			infotreeobj.children = [];
			infotreeobj.level = firstNode.level;
			//infotreeobj.isload="false";
			if ((firstNode.hasOwnProperty("nodes")) && (firstNode.nodes.length > 0) && (firstNode.level < 2)) {
				infotreeobj.children = decode(firstNode.nodes);

			}
			infotreedata.push(infotreeobj);
			maps = [];
			GetSensorsByNode(infotreeobj.id)//获取指定节点下的标签信息
			GetBinariesByType("NodeGraphic", infotreeobj.id);
			//setTimeout(function(){if(sessionStorage.pageindex==0){
			//	document.getElementById("iframe_main").src="infototal.html";
			//}},3000);
		}
		function getThe_level_nodeid(anode, alevel) {
			while (anode.level > alevel) {
				anode = ($("#tree").treeview("getParent", anode))
			}
			return anode;
		}
		function decode(adata) {
			var infotree = [];
			for (var i = 0; i < adata.length; i++) {
				var tempobj = new Object();
				tempobj.name = adata[i].text;
				tempobj.id = adata[i].id
				tempobj.level = adata[i].level;
				if (adata[i].level < 2) {
					if ((adata[i].hasOwnProperty("nodes")) && adata[i].nodes.length > 0) {
						tempobj.value = adata[i].nodes.length;
						tempobj.children = [];
						tempobj.children = decode(adata[i].nodes);
					} else {
						tempobj.value = 0;
					}
				} else {
					tempobj.value = 0;
				}
				infotree.push(tempobj);

			}
			return infotree;
		}
		function decode_sensors(adata) {
			var infotree = [];
			var ishavechild = false;
			for (var i = 0; i < adata.nodes.length; i++) {
				if ((adata.hasOwnProperty("nodes")) && adata.nodes.length > 0) {
					//adata=adata.nodes;
					var tempobj = new Object();
					tempobj.name = adata.text;
					tempobj.id = adata.id;
					tempobj.level = adata.level;
					tempobj.value = adata.nodes.length;
					tempobj.children = [];
					ishavechild = true;
					//var tempobj=new Object();
					//if((adata[i].hasOwnProperty("nodes"))&&adata[i].nodes.length>0){
					tempobj.children = decode_sensors(adata.nodes);
					//}
				}
			}

			return infotree;
		}
		//book,math,english,chinese,lab,library,office,classroom,glass,class,white，blue，red，green，black，yellow，gray，brown，upon，eyes，ears，legs，arms，
		//feet，body，head，nose，mouth，figer，heat，teeth，tongue，face，hand，tall，short，fat，thin，hair，erase，pen，pencil，ruler，ruber I,my,mine,me,you,you
		//your,yours,he(she),him(her),his(her),his(hers),it,it,its.they,them,their,theirs,we,us,our,ours,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday
		//one two three,four,five,six,seven,eight,nine,ten,eleven,twelve,thirteen,fourteen,hundred,thousand,million,billion, computer,picture,jump,sit,stant,stay,
		//page,data,up,on,in,at,look,out,of,for,from,form,list,short,tall,hight,small,big,bed,bee,bear,wolf,fox,fish,meat,nodle,rice,fine,nine,fly,sky,run,play,bath,
		//water,what,when,where,how,who,whose,name,age,thin,hair,shop,stor,school,walk,work,doctor,teacher,student,driver,bus,car,job,sun,daughter,policeman,drive,
		//member,talk,rodio,family,photo,Smith.listen to,upon,early,near,by,front,back,left,right,up,down,box,fox,cup,run,jump,paper,pen,ruler,ruber,erase
		//从后台获取节点信息 China,Canada,United State of American,England,Japen,Indian,German,Sweden,Greece,Poland,Franch,Itali,Kore,here,there,game,glass,cup,bottle,

		function getNodes() {
			var url = jfjk_base_config.baseurl + "/GetNodes";
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function (request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'GET',
					dataType: 'json',
					timeout: 10000,
					error: function (jqXHR, textStatus, errorThrown) {
						inittreeview();
						layer.alert('获取系统目录列表数据失败');
						errortime++;
					},
					success: function (data, status) {
						var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						if (status == "success") {
							errortime = 0;
							sessionStorage.islogin = true;
							if (data.Error == null) {
								var obj_nodes = [];
								var result = data.Result;
								if (!jQuery.isEmptyObject(result.Nodes)) {
									obj_nodes = data.Result.Nodes;
								} else {
									obj_nodes = null;
								}
								nodes = buildnode(obj_nodes, 0);
								inittreeview(nodes);
								GetSensors();//将标签挂接到节点树。
							} else {
								layer.alert(data.Error);
								sessionStorage.islogin = ture;
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", 2000);
				inittreeview(null, 0);
			}
		}
		function buildnode(data, level) {
			var tree = [];
			if (data == null || data == undefined) {
				for (i = 0; i < 3; i++) {
					var nodes = new Object();
					nodes.text = "变电站" + (2 - i);
					nodes.id = i;
					nodes.nodes = [];
					nodes.icon = "url(res/lock.png)";
					var node = '[{"text":"测温","id":' + ((i + 1) * 10) + ',"icon":"glyphicon glyphicon-user"},{"text":"局部放电","id":' + ((i + 1) * 10 + 1) + '},{"text":"弧光保护","id":' + ((i + 1) * 10 + 2) + '},{"text":"视频监控","id":' + ((i + 1) * 10 + 3) + '},{"text":"机房监控","id":' + ((i + 1) * 10 + 4) + ',"nodes":[{"text":"门禁","id":543},{"text":"水浸","id":345}]}]';
					nodes.nodes = (JSON.parse(node));
					//var lnode=new Object();
					tree.push(nodes);
				}
			} else {
				for (var j = 0; j < data.length; j++) {
					var nodes = new Object();
					nodes.text = data[j].Value.Name;
					nodes.id = data[j].Value.Id;
					nodes.Catalog = data[j].Value.Catalog;
					nodes.Config = data[j].Value.Config;
					nodes.Time = data[j].Value.Time;
					nodes.level = level;
					if (data[j].Value.hasOwnProperty("NodeId")) {
						nodes.NodeId = data[j].Value.NodeId;
					}
					var icon = 'glyphicon glyphicon-user';
					switch (data[j].Value.Name) {
						case "石家庄":
						case "视频监控":
							icon = "glyphicon glyphicon-facetime-video";//
							break;
						case "保定":
						case "测温":
							icon = "glyphicon glyphicon-adjust";//glyphicon glyphicon-tree-conifer glyphicon glyphicon-bullhorn
							break;
						case "烟感":
						case "清苑":
							icon = "glyphicon glyphicon-refresh";//glyphicon glyphicon-leaf  glyphicon glyphicon-tint  glyphicon glyphicon-flash
							break;
						case "局部放电":
						case "安国":
							icon = "glyphicon glyphicon-flash";//
							break;
						case "弧光保护":
						case "唐县":
							icon = "glyphicon glyphicon-bullhorn";//
							break;
						case "机房监控":
							icon = 'glyphicon glyphicon-inbox';//
							break;
						case "门禁":
							icon = 'glyphicon glyphicon-lock';//
							break;
						case "灯光":
							icon = 'glyphicon glyphicon-cog';
							break;
						case "红外":
							icon = 'glyphicon glyphicon-signal';
							break;
						case "动力":
							icon = 'glyphicon glyphicon-retweet';
							break;
						case "环境":
						case "行唐":
							icon = "glyphicon glyphicon-leaf";//
							break;
						case "水浸":
						case "郑州":
							icon = "glyphicon glyphicon-tint";//
					}
					if (level == 0) {
						icon = "glyphicon glyphicon-home"
					}
					nodes.icon = icon;
					var chi_len = data[j].Children.length;
					if (chi_len != 0) {
						nodes.nodes = [];
						nodes.nodes = buildnode(data[j].Children, level + 1)
					}
					tree.push(nodes);
				}
			}
			return tree;
		}

		function showdownload() {
			document.getElementById("iframe_main").src = "app_download.html"
		}
		function showhelp() {
			document.getElementById("iframe_main").src = "help.html"
		}
		function showcontactus() {
			document.getElementById("iframe_main").src = "ContactUs.html"
		}
		function loaddata(mdata) {
			if ((mdata.text === "保定") || (mdata.text == "测温")) {
				document.getElementById("realstate").style.display = "inline";
			} else {
				document.getElementById("realstate").style.display = "none";
			}
		}
		function reloadDataGrid() {
			isfree = "true";
		}
		//获取指定节点的图形列表
		function GetBinariesByType(atype, anodeid) {
			var url = jfjk_base_config.baseurl + "/GetBinariesByType?type=" + atype + "&typeid=" + anodeid;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				//if((aparent==undefined)||(aparent!=1)){
				//ajaxLoadingShow();
				//}
				$.ajax({
					beforeSend: function (request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'GET',
					dataType: 'json',
					timeout: 10000,
					error: function (jqXHR, textStatus, errorThrown) {
						//inittreeview();
						ajaxLoadingHidden();
						layer.alert('获取系统列表数据失败');
						errortime++;
						//isfree="true";
					},
					success: function (data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						ajaxLoadingHidden();
						if (status == "success") {
							errortime = 0;
							//isfree="true";
							if (data.Error == null) {
								var obj_Binaries = [];
								var result = data.Result;
								if (!jQuery.isEmptyObject(result.Binaries)) {
									//sessionStorage.setItem("sensors",JSON.stringify(buildsensor(data.Result.Sensors)));
									obj_Binaries = data.Result.Binaries;
									//var binaries=buildbinaries(data.Result.Binaries);//(JSON.parse(localStorage.getItem("sensors")));
									localStorage.setItem("binaries", JSON.stringify(obj_Binaries));
									//localStorage.binaries=obj_Binaries;
									refreshiframe();
								} else {
									localStorage.setItem("binaries", null);
									sessionStorage.islogin = true;
									refreshiframe();
								}
							} else {
								localStorage.setItem("binaries", null);
								layer.alert(data.Error);
								sessionStorage.islogin = true;
								refreshiframe();
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", 2000);
				//inittreeview(null,0);
			}
			//if(atype==0){
			refreshiframe();
			//}
		}
		function GetSensorsByNode(anodeid) {
			var url = jfjk_base_config.baseurl + "/GetSensorsByNode?nodeId=" + anodeid;
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function (request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'GET',
					dataType: 'json',
					timeout: 10000,
					error: function (jqXHR, textStatus, errorThrown) {
						//inittreeview();
						layer.alert('获取系统列表数据失败');
						errortime++;
						isfree = "true";
					},
					success: function (data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						if (status == "success") {
							errortime = 0;
							isfree = "true";
							if (data.Error == null) {
								var obj_sensors = [];
								var result = data.Result;
								if (!jQuery.isEmptyObject(result.Sensors)) {
									//sessionStorage.setItem("sensors",JSON.stringify(buildsensor(data.Result.Sensors)));
									maps = [];
									var sensors = buildsensor(data.Result.Sensors);//(JSON.parse(localStorage.getItem("sensors")));
									localStorage.setItem("sensors", JSON.stringify(sensors));
									//var sensors=(JSON.parse(localStorage.getItem("sensors")));
									//var localsensors=buildsensor(data.Result.Sensors);
									//updatainfotree(infotreedata, anodeid,sensors.length,sensors);
									refreshiframe();
								} else {
									localStorage.setItem("sensors", null);
									sessionStorage.islogin = true;
									refreshiframe();
								}
							} else {
								localStorage.setItem("sensors", null);
								layer.alert(data.Error);
								sessionStorage.islogin = true;
								refreshiframe();
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", 2000);
				inittreeview(null, 0);
			}
			//if(atype==0){
			refreshiframe();
			//}
		}
		function refreshiframe() {
			switch (sessionStorage.pageindex) {
				case '0':
					document.getElementById("iframe_main").src = "infototal.html";
					break;
				case "1":
					document.getElementById("iframe_main").src = "drawmap.html";
					//getrealdatabynodeid(-1);
					//iframe_main.window.initpage();
					break;
				case '2':
					document.getElementById("iframe_main").src = "realdata.html";//getrealdatabynodeid(-1);
					//iframe_main.window.initpage();
					break;
				case '3':
					document.getElementById("iframe_main").src = "historydata.html";
					//iframe_main.window.initpage();
					break;
				case '4':
					document.getElementById("iframe_main").src = "chart.html";
					//iframe_main.window.inithistorychart();
					break;
				case '5':
					document.getElementById("iframe_main").src = "warnlog.html";
					break;
			}
		}
		function GetSensors() {
			var url = jfjk_base_config.baseurl + "/GetSensors";
			url = encodeURI(url);
			if (sessionStorage.islogin == "true") {
				$.ajax({
					beforeSend: function (request) {
						request.setRequestHeader("_token", sessionStorage.token);
					},
					url: url,
					type: 'GET',
					dataType: 'json',
					timeout: 10000,
					error: function (jqXHR, textStatus, errorThrown) {
						//inittreeview();
						layer.alert('获取系统列表数据失败');
						errortime++;
						isfree = "true";
					},
					success: function (data, status) {
						//var reg = new RegExp("(^|&)value1=([^&]*)(&|$)");
						if (status == "success") {
							errortime = 0;
							isfree = "true";
							if (data.Error == null) {
								var obj_sensors = [];
								var result = data.Result;
								if (!jQuery.isEmptyObject(result.Sensors)) {
									//sessionStorage.setItem("sensors",JSON.stringify(buildsensor(data.Result.Sensors)));
									//allsensors=buildnode(data.Result.Sensors,3);//(JSON.parse(localStorage.getItem("sensors")));
									maps=[];
									allsensors = [];
									buildsensor2(allsensors, data.Result.Sensors, "");
									localStorage.setItem("allsensors",JSON.stringify(buildsensor(data.Result.Sensors)));
									//var sensors=(JSON.parse(localStorage.getItem("sensors")));
									//var localsensors=buildsensor(data.Result.Sensors);
									//updatanodetree();

								} else {
									allsensors = null;
									//localStorage.setItem("allsensors",null);
								}

							} else {
								localStorage.setItem("allsensors", null);
								layer.alert(data.Error);
								sessionStorage.islogin = ture;
							}
						}
					}
				});
			} else {
				Alert("用户未登录，您无权完成此次操作", 2000);
				inittreeview(null, 0);
			}
		}
		function updatainfotree(treedata, tnodeid, tsensors) {//,tvalue
			if (treedata != null && treedata != undefined) {
				for (var j = 0; j < treedata.length; j++) {
					if (treedata[j].id == tnodeid) {
						if (!treedata[j].hasOwnProperty("nodes")) {
							treedata[j].nodes = [];
						}
						treedata[j].nodes.push(tsensors);
						//var sumnode=sumseneor(tsensors);
						return;
					}
					if ((treedata[j].hasOwnProperty("nodes")) && (treedata[j].nodes.length > 0) && (treedata[j].level < 2)) {
						updatainfotree(treedata[j].nodes, tnodeid, tsensors);//tvalue,
					}
				}
			}
		}
		function sumseneor(asensors) {
			if ((asensors != undefined) && (asensors != null)) {
				var map1 = new Object();
				for (var i = 0; i < asensors.length; i++) {
					if ((asensors[i] != null)) {
						var key = asensors[i].Catalog;//Group;
						if (key == null || key == '' || key.trim() == '') {//空、空字符、空格都按空对待，提示未分组。
							key = "未分组";
						}
						if (map1.hasOwnProperty(key)) {
							map1[key]++
						} else {
							map1[key] = 1;//value++
						}
					}
				}
			}
			return map1;
		}
		function buildsensor1(aSensors) {
			if ((aSensors != undefined) && (aSensors != null)) {
				for (var j = 0; j < aSensors.length; j++) {
					var nodes = new Object();
					nodes.name = aSensors[j].text;
					nodes.id = aSensors[j].id;
					nodes.Catalog = aSensors[j].Catalog;
					nodes.Config = aSensors[j].Config;
					nodes.Time = aSensors[j].Time;
					maps.push(nodes);

					if ((aSensors[j].hasOwnProperty("nodes") && (aSensors[j].nodes.length > 0))) {
						buildsensor1(aSensors[j].nodes);
					}
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.Name;
					var val2 = obj2.Name;
					if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}
				}
				return (maps.sort(compare));
			}
		}
		function buildsensor2(obj, aSensors, parentkey) {
			if ((aSensors != undefined) && (aSensors != null)) {
				for (var i = 0; i < aSensors.length; i++) {
					var s = aSensors[i];
					if (s != null && !jQuery.isEmptyObject(s.Value)) {
						var v = s.Value
						var map = new Object();
						map.id = v.Id;
						map.Value = v;
						var key = $.trim(parentkey);
						if (v.Address && $.trim(v.Address) != "") {
							key = key ? key + "_" + v.Address : v.Address;
						}
						if ((!jQuery.isEmptyObject(s.Children))) {
							buildsensor2(obj, s.Children, key);
						}
						if (v.Catalog && $.trim(v.Catalog) != "") {
							key = key ? key + "_" + v.Catalog : v.Catalog;
						}
						obj[key.toLowerCase()] = map;
					}
				}
			}
		}
		function buildsensor(aSensors) {
			if ((aSensors != undefined) && (aSensors != null)) {
				for (var i = 0; i < aSensors.length; i++) {
					if ((aSensors[i] != null) && (!jQuery.isEmptyObject(aSensors[i].Value))) {
						var map = new Object();
						map.id = aSensors[i].Value.Id;
						map.Value = aSensors[i].Value;
						maps.push(map);
					}
					if ((aSensors[i] != null) && (!jQuery.isEmptyObject(aSensors[i].Children))) {
						buildsensor(aSensors[i].Children);
					}
				}
				var compare = function (obj1, obj2) {
					var val1 = obj1.Value.Name;
					var val2 = obj2.Value.Name;
					if (val1 < val2) {
						return -1;
					} else if (val1 > val2) {
						return 1;
					} else {
						return 0;
					}
				}
				return (maps.sort(compare));
			}
		}
		//window.setInterval("getrealdatabynodeid(-1)",60000);

		function decoderealdata(obj_realdata) {
			var sensorname = "",
				alerttime = "",
				alertinfo = "",
				alertvalue = "";
			var tbody = document.getElementById('realwarningdata-tbody');
			var tableLength = tbody.rows.length;
			for (var int = 0; int < tableLength; int++) {
				tbody.deleteRow(0);
			}
			var sensors = allsensors;
			
			var obj_data = new Object();
			var pt = 0;
			if (sensors != null) {
				var str_alert = "告警：";
				var gaojing = document.getElementById("alert_info");
				if (gaojing == null) {
					gaojing = parent.window.document.getElementById("alert_info");
				}
				var fdck = document.getElementById("KeFuDiv");
				if (fdck == null) {
					fdck = parent.window.document.getElementById("KeFuDiv");
				}
				var speech = document.getElementById("chatData");
				if (speech == null) {
					speech = parent.window.document.getElementById("chatData");
				}
				if(sessionStorage.contents){
					var graphic = JSON.parse(sessionStorage.contents);

					var obj = []
					graphic.forEach(g => {
						//67: "{"_type":"Monitor","_shape":{"Binding":"23_009_tmp","StrokeColor":"#FFFFFFFF","StrokeThinkness":3.0,"StartPoint":"628,266","
						//EndPoint":"673.672,281.24","Text":"--------","FontFamily":"Microsoft YaHei UI","FontStyle":"Normal","FontWeight":"Normal","FontStretch":"Normal","FontSize":12.0,"TextSpace":0.1,"Vertical":false},"_matrix":"1,0,0,1,-285,-54"}"
						if ($.trim(g).length > 0) {
							g = JSON.parse(g);
							if (g && g._shape && g._shape.Binding && g._shape.Text) {
								if(allsensors[g._shape.Binding]){
									var sid=allsensors[g._shape.Binding].id;
									if (obj_realdata.hasOwnProperty(sid)) {

										obj_data = (obj_realdata)[sid];////
										g._shape.Text =(obj_data[0].Value*1).toFixed(Number_of_decimal);// + " " + sensors[g._shape.Binding].Value.Unit ;
										if(obj_data[0].Message){
											g._shape.IsError=true;
										}else{
											g._shape.isError=false;
										}
									}
							}
						}
							obj.push(JSON.stringify(g));
						}
					});
					sessionStorage.setItem("contents",JSON.stringify(obj))
				}
				var sensors=JSON.parse(localStorage.getItem("allsensors"));
				for (var i = 0; i < sensors.length; i++) {
					var sid = sensors[i].id + "";
					if (obj_realdata.hasOwnProperty(sid)) {
						obj_data = (obj_realdata)[sid];////
						var msg = obj_data[0].Message;
						if (msg == null || msg == "" || msg == undefined || msg.trim() == "") {
							continue;
						}
						alerttime = obj_data[0].Time.substr(11);
						alertinfo = msg;
						alertvalue = parseFloat(obj_data[0].Value).toFixed(Number_of_decimal);
						sname = sensors[i].Value.Name;
						var xs = 1;//sensors[i].Value.Factor;  数据结构修改，value为已经乘过系数的数值，svalue为未乘以系统的原始值
						var type_td = getname(sensors[i].Value.Catalog);
						//添加数据列表项
						var tr = document.createElement('tr');
						//tr.setAttribute("ondblclick","tableclick(this)");
						var tdename = document.createElement('td');
						var tdid = document.createElement('td');
						var tdtype = document.createElement('td');
						var tdtime = document.createElement('td');
						var tdvalue = document.createElement('td');
						//var tdvalue2 = document.createElement('td');
						//var tdhistory = document.createElement('td');
						//var tdwarnlog = document.createElement('td');
						var tdmessage = document.createElement('td');
						tdename.innerHTML = sname;
						tdid.innerHTML = sid;
						//tdid.style.cssText="display:none";
						tdtype.innerHTML = type_td;
						tdtype.style.cssText = "display:none";
						tdtime.innerHTML = obj_data[0].Time; //jsonObject[i].color;
						tdvalue.innerHTML = (obj_data[0].Value * xs).toFixed(Number_of_decimal);
						//tdvalue2.innerHTML = (obj_data[0].Value*xs/1.5).toFixed(Number_of_decimal);
						//tdhistory.setAttribute('backgroundColor', '#ffffff');
						//tdhistory.setAttribute('onclick', 'tohistory(' + sid + ')');
						//tdhistory.innerHTML = "<button href='javascript:void(0)'>>></button>";
						//tdwarnlog.setAttribute('onclick', 'towarnlog(' +sid + ')');
						//tdwarnlog.setAttribute('backgroundColor', '#ffffff');
						//tdwarnlog.style.cssText="display:none";
						//tdwarnlog.innerHTML = '<button href="javascript:void(0)">>></button>';
						tdmessage.innerHTML = msg;
						//tdmessage.style.cssText="display:none";
						tr.appendChild(tdid);
						tr.appendChild(tdename);
						tr.appendChild(tdtime);
						tr.appendChild(tdvalue);
						//tr.appendChild(tdvalue2);
						//tr.appendChild(tdhistory);
						//tr.appendChild(tdwarnlog);//z不显示不显示
						tr.appendChild(tdtype);//不显示//不显示
						tr.appendChild(tdmessage);// 告警信息
						var cl = "#FFFFFF";
						//隔行显示不同的颜色
						if (pt % 2 == 0) {
							cl = "#16b9c9";
						}
						tr.style.backgroundColor = cl;
						//tr.cells[1].style.backgroundColor = cl;
						//tr.cells[2].style.backgroundColor = cl; stationname +
						//tr.cells[3].style.backgroundColor = cl;
						pt++;
						tbody.appendChild(tr);
						if ((alertvalue !== null) && (alertvalue !== "NaN")) {
							str_speech = "告警" +  sname + alertinfo + "数值" + alertvalue;
							str_alert = str_alert + " " + alerttime + "  " + ": " + sname + " " + type_td+" "+ alertinfo + " 数值为:" + alertvalue;
						} else {
							str_speech = "告警" + sname + alertinfo;
							str_alert = str_alert + " " + alerttime + "  " +": " + sname + " "+ type_td+" " + alertinfo + " ";// + alertvalue;
						}
					}
				}
				if (pt > 0) {
					gaojing.innerHTML = "<pre  style='vertical-align:center;background-color: rgba(255,255,0,0);'>" + str_alert + "</pre>";
					//speech.innerHTML = str_speech;
					//speech.click();
					fdck.style.display = "block";
				} else {
					gaojing.innerText = "";
					//speech.innerHTML = "";
					//fdck.style.display = "none";
				}
			}/*else{
			layer.alert("没有符合条件的数据");
		}*/
			//tbody.rows[t_pt].scrollIntoView();
			//refreshData();
		}
		/*function refreshData(){
	
		}*/
		function updatanodetree() {
			if (allsensors != undefined && allsensors != null) {
				for (var i = 0; i < allsensors.length; i++) {
					if (allsensors[i] != null) {
						var s_nodeid = allsensors[i].NodeId;
						updatainfotree(nodes, s_nodeid, allsensors[i]);
					}
				}
				inittreeview(nodes);
			}
		};
	</script>

</body>

</html>